<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Paste Backfill Plant Map | MineSmart</title>
<meta name="description" content="Interactive map of 190+ paste backfill plants worldwide. Explore capacity, commodity, and regional data.">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a1a1f;--panel:#0d2329;--card:#112e36;--accent:#00a99d;--brand:#004a59;--text:#e0e8ea;--muted:#7a9ca8;--border:#1a3f4a;--red:#e74c3c;--yellow:#f1c40f;--green:#2ecc71}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh;display:flex;flex-direction:column}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}

/* Header */
.header{background:linear-gradient(135deg,var(--brand),#002a33);padding:8px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--accent);z-index:1000;flex-shrink:0}
.header-left{display:flex;align-items:center;gap:12px}
.header-left img{height:32px}
.header-left h1{font-size:18px;font-weight:600;letter-spacing:0.5px}
.header-right{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#fff;border:none;padding:7px 14px;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
.btn:hover{background:#00c9b7;transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--accent);color:var(--accent)}
.btn-outline:hover{background:var(--accent);color:#fff}

/* Main layout */
.main{display:flex;flex:1;overflow:hidden}
.map-container{flex:1;position:relative;min-width:0}
#map{width:100%;height:100%;background:var(--bg)}

/* Sidebar */
.sidebar{width:380px;background:var(--panel);overflow-y:auto;border-left:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column}
.sidebar::-webkit-scrollbar{width:6px}
.sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Backfill Pro banner */
.bp-banner{background:linear-gradient(135deg,#004a59,#006b70);padding:14px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--accent);cursor:pointer;transition:background .2s}
.bp-banner:hover{background:linear-gradient(135deg,#005a69,#007b80)}
.bp-banner .bp-icon{font-size:28px;flex-shrink:0}
.bp-banner .bp-text h3{font-size:14px;font-weight:600;color:#fff;margin-bottom:2px}
.bp-banner .bp-text p{font-size:11px;color:var(--muted)}
.bp-banner .bp-arrow{margin-left:auto;color:var(--accent);font-size:18px;flex-shrink:0}

/* Stats cards */
.stats-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px}
.stat-card{background:var(--card);border-radius:6px;padding:12px;text-align:center;border:1px solid var(--border)}
.stat-card .value{font-size:24px;font-weight:700;color:var(--accent)}
.stat-card .label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px}

/* Chart sections */
.chart-section{padding:8px 12px}
.chart-section h3{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:6px;border-bottom:1px solid var(--border);padding-bottom:4px}
.chart-wrap{position:relative;max-height:200px}

/* News section */
.news-section{padding:8px 12px;border-top:1px solid var(--border)}
.news-section h3{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px;border-bottom:1px solid var(--border);padding-bottom:4px}
.news-item{padding:6px 0;border-bottom:1px solid var(--border)}
.news-item:last-child{border:none}
.news-item a{font-size:13px;font-weight:500;line-height:1.3;display:block}
.news-item .news-meta{font-size:10px;color:var(--muted);margin-top:2px}
.news-empty{font-size:12px;color:var(--muted);font-style:italic;padding:8px 0}

/* CTA */
.cta-section{padding:12px;display:flex;flex-direction:column;gap:6px;margin-top:auto}
.cta-section .btn{text-align:center;font-size:14px;padding:10px}

/* Filter bar on map */
.filter-bar{position:absolute;top:10px;left:50px;right:10px;z-index:800;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.filter-bar select,.filter-bar input{background:rgba(13,35,41,0.95);color:var(--text);border:1px solid var(--border);padding:6px 10px;border-radius:4px;font-size:12px;backdrop-filter:blur(8px)}
.filter-bar input{width:180px}
.filter-bar select{min-width:110px}
.filter-bar select:focus,.filter-bar input:focus{outline:none;border-color:var(--accent)}

/* Footer */
.footer{background:var(--brand);padding:6px 20px;font-size:11px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;border-top:1px solid var(--border)}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;justify-content:center;align-items:center}
.modal-overlay.active{display:flex}
.modal{background:var(--panel);border-radius:8px;padding:24px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}
.modal h2{margin-bottom:16px;font-size:18px;color:var(--accent)}
.modal label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px;text-transform:uppercase;letter-spacing:0.5px}
.modal input,.modal select,.modal textarea{width:100%;background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:4px;font-size:13px}
.modal textarea{height:60px;resize:vertical}
.modal input:focus,.modal select:focus,.modal textarea:focus{outline:none;border-color:var(--accent)}
.modal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}
.modal .close-btn{position:absolute;right:12px;top:12px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer}
.correction-note{background:var(--card);border:1px solid var(--yellow);border-radius:4px;padding:8px 10px;margin-bottom:8px;font-size:12px;color:var(--yellow);display:none}

/* Toast */
.toast{position:fixed;bottom:20px;right:20px;background:var(--green);color:#fff;padding:12px 20px;border-radius:6px;font-size:14px;font-weight:500;z-index:3000;display:none;box-shadow:0 4px 12px rgba(0,0,0,.4)}

/* Leaflet overrides */
.leaflet-popup-content-wrapper{background:var(--card);color:var(--text);border-radius:6px;border:1px solid var(--border)}
.leaflet-popup-tip{background:var(--card)}
.leaflet-popup-content{margin:10px 14px;font-size:13px;line-height:1.5}
.leaflet-popup-content h4{color:var(--accent);margin-bottom:4px;font-size:15px}
.leaflet-popup-content .popup-row{display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid var(--border)}
.leaflet-popup-content .popup-row:last-child{border:none}
.leaflet-popup-content .popup-label{color:var(--muted);font-size:11px}
.leaflet-popup-content .popup-val{font-weight:500}
.leaflet-popup-content .suggest-link{display:inline-block;margin-top:6px;font-size:11px;color:var(--accent)}
.leaflet-control-zoom a{background:var(--card)!important;color:var(--text)!important;border-color:var(--border)!important}
.marker-cluster{background:rgba(0,169,157,0.3)!important}
.marker-cluster div{background:rgba(0,169,157,0.7)!important;color:#fff!important;font-weight:600}

/* Responsive */
@media(max-width:900px){
  .main{flex-direction:column}
  .map-container{height:50vh}
  .sidebar{width:100%;border-left:none;border-top:1px solid var(--border)}
  .filter-bar{left:10px;right:10px;top:10px}
  .header-left h1{font-size:14px}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <img src="https://minesmart.io/wp-content/uploads/2023/03/MineSmart-Logo-White.png" alt="MineSmart" onerror="this.style.display='none'">
    <h1>Global Paste Backfill Plant Map</h1>
  </div>
  <div class="header-right">
    <button class="btn btn-outline" onclick="openModal()">+ Submit a Mine</button>
    <a href="https://minesmart.io/backfill-pro/" target="_blank" class="btn">Request a Demo</a>
  </div>
</div>

<div class="main">
  <div class="map-container">
    <div class="filter-bar">
      <input type="text" id="searchBox" placeholder="üîç Search mines...">
      <select id="filterRegion"><option value="">All Regions</option></select>
      <select id="filterCommodity"><option value="">All Commodities</option></select>
      <select id="filterStatus"><option value="">All Statuses</option></select>
      <select id="filterConfidence"><option value="">All Confidence</option><option value="verified" selected>Verified Only</option><option value="likely">Likely</option></select>
    </div>
    <div id="map"></div>
  </div>

  <div class="sidebar">
    <!-- Backfill Pro banner at top -->
    <div class="stats-row">
      <div class="stat-card"><div class="value" id="totalMines">‚Äî</div><div class="label">Paste Plants</div></div>
      <div class="stat-card"><div class="value" id="totalTpd">‚Äî</div><div class="label">Total TPD</div></div>
    </div>

    <div class="chart-section">
      <h3>By Region</h3>
      <div class="chart-wrap"><canvas id="chartRegion"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Top 10 by Capacity (tpd)</h3>
      <div class="chart-wrap" style="max-height:220px"><canvas id="chartTop10"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Primary Commodity</h3>
      <div class="chart-wrap"><canvas id="chartCommodity"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Commissioning Timeline</h3>
      <div class="chart-wrap"><canvas id="chartTimeline"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Status</h3>
      <div class="chart-wrap"><canvas id="chartStatus"></canvas></div>
    </div>

    <!-- News section -->
    <div class="news-section">
      <h3>üì∞ Industry News</h3>
      <div id="newsFeed"><div class="news-empty">Loading news...</div></div>
    </div>

    <div class="cta-section">
      <a href="https://minesmart.io/backfill-pro/" target="_blank" class="btn">Learn about Backfill Pro</a>
      <a href="https://minesmart.io/backfill-pro/" target="_blank" class="btn btn-outline">Request a Demo</a>
    </div>
  </div>
</div>

<div class="footer">
  <span>Powered by <a href="https://minesmart.io" target="_blank">MineSmart Solutions Ltd</a> | <strong>Backfill Pro</strong> ‚Äî Paste Operations Management Platform</span>
  <span>Data: L-P G√©linas, industry reports, public filings</span>
</div>

<!-- Submit Modal -->
<div class="modal-overlay" id="submitModal">
  <div class="modal" style="position:relative">
    <button class="close-btn" onclick="closeModal()">&times;</button>
    <h2 id="modalTitle">Submit a Mine</h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Know of a paste backfill plant not on the map? Submit it here.</p>
    <div class="correction-note" id="correctionNote">üìù You are suggesting a correction for an existing mine.</div>
    <input type="hidden" id="fSubmissionType" value="new">
    <label>Mine Name *</label><input id="fName" required>
    <div id="existingMineRow" style="display:none">
      <label>Existing Mine Name (if correcting)</label><input id="fExistingMine">
    </div>
    <label>Company</label><input id="fCompany">
    <label>Country</label><input id="fCountry">
    <label>Fill Type</label>
    <select id="fType"><option>Paste</option><option>Cemented Paste</option><option>Thickened Tailings</option><option>Other</option></select>
    <label>Paste Capacity (tpd)</label><input id="fTpd" type="number">
    <label>Number of Plants</label><input id="fPlants" type="number" value="1">
    <label>Year Commissioned</label><input id="fYear" type="number">
    <label>Primary Commodity</label><input id="fCommodity">
    <label>Latitude</label><input id="fLat" type="number" step="any" placeholder="e.g. -33.8688">
    <label>Longitude</label><input id="fLng" type="number" step="any" placeholder="e.g. 151.2093">
    <label>Notes</label><textarea id="fNotes" placeholder="Any additional details..."></textarea>
    <label>Your Name *</label><input id="fSubmitter" required>
    <label>Your Email</label><input id="fEmail" type="email">
    <label>Source / Reference</label><textarea id="fSource"></textarea>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn" onclick="submitMine()">Submit</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SUPABASE_URL = 'https://cxsariervcthxoudumaq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4c2FyaWVydmN0aHhvdWR1bWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTcwMTAsImV4cCI6MjA4Nzc3MzAxMH0.KmjcyBRtRRgvg4FZarJ935wjcKZ4PTThszKWbFPzwUY';

const REGION_COLORS = {
  'North America':'#3498db','South America':'#e74c3c','Europe':'#f39c12',
  'Africa':'#9b59b6','Asia':'#1abc9c','Australia':'#e67e22'
};
const STATUS_COLORS = {
  'operating':'#2ecc71','closed':'#e74c3c','care & maintenance':'#f39c12',
  'planned':'#3498db','under construction':'#9b59b6','commissioning 2026':'#1abc9c','':'#7f8c8d'
};

let allData=[], map, clusterGroup, charts={};

// Chart.js defaults
Chart.defaults.color='#7a9ca8';
Chart.defaults.borderColor='#1a3f4a';
Chart.defaults.font.size=11;
Chart.defaults.plugins.legend.labels.boxWidth=10;
Chart.defaults.animation.duration=800;

fetch('data.json').then(r=>r.json()).then(data=>{
  allData=data;
  populateFilters(data);
  initMap();
  applyFilters();
});

// Load news
loadNews();

async function loadNews() {
  try {
    const res = await fetch(SUPABASE_URL + '/rest/v1/paste_news?order=published_at.desc&limit=8', {
      headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY }
    });
    if (!res.ok) throw new Error('API error');
    const news = await res.json();
    const container = document.getElementById('newsFeed');
    if (!news.length) {
      container.innerHTML = '<div class="news-empty">News feed coming soon...</div>';
      return;
    }
    container.innerHTML = news.map(n => {
      const date = n.published_at ? new Date(n.published_at).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'}) : '';
      return `<div class="news-item">
        <a href="${esc(n.url)}" target="_blank">${esc(n.title)}</a>
        <div class="news-meta">${n.source ? esc(n.source) + ' ¬∑ ' : ''}${date}</div>
      </div>`;
    }).join('');
  } catch(e) {
    document.getElementById('newsFeed').innerHTML = '<div class="news-empty">News feed coming soon...</div>';
  }
}

function esc(s) { const d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }

function populateFilters(data){
  const add=(id,vals)=>{const s=document.getElementById(id);vals.forEach(v=>{if(v){const o=document.createElement('option');o.value=v;o.textContent=v;s.appendChild(o)}})};
  add('filterRegion',[...new Set(data.map(d=>d.region))].sort());
  add('filterCommodity',[...new Set(data.map(d=>(d.commodity||'').split('/')[0]).filter(Boolean))].sort());
  add('filterStatus',[...new Set(data.map(d=>d.status).filter(Boolean))].sort());
  document.querySelectorAll('.filter-bar select, .filter-bar input').forEach(el=>el.addEventListener('input',applyFilters));
}

function applyFilters(){
  const region=document.getElementById('filterRegion').value;
  const commodity=document.getElementById('filterCommodity').value;
  const status=document.getElementById('filterStatus').value;
  const confidence=document.getElementById('filterConfidence').value;
  const search=document.getElementById('searchBox').value.toLowerCase();
  const filtered=allData.filter(d=>{
    if(region && d.region!==region) return false;
    if(commodity && !(d.commodity||'').toLowerCase().includes(commodity.toLowerCase())) return false;
    if(status && d.status!==status) return false;
    if(confidence && d.confidence!==confidence) return false;
    if(search && !d.name.toLowerCase().includes(search) && !(d.company||'').toLowerCase().includes(search) && !(d.country||'').toLowerCase().includes(search)) return false;
    return true;
  });
  renderAll(filtered);
}

function initMap(){
  map=L.map('map',{zoomControl:true,attributionControl:false}).setView([20,0],2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:18}).addTo(map);
  L.control.attribution({prefix:false,position:'bottomright'}).addAttribution('¬© <a href="https://carto.com">CARTO</a> ¬© <a href="https://osm.org">OSM</a>').addTo(map);
}

function renderAll(data){
  renderMap(data);
  renderStats(data);
  renderCharts(data);
}

function renderMap(data){
  if(clusterGroup) map.removeLayer(clusterGroup);
  clusterGroup=L.markerClusterGroup({maxClusterRadius:40,spiderfyOnMaxZoom:true});
  const maxTpd=Math.max(...data.map(d=>d.tpd||0),1);
  data.forEach(d=>{
    if(!d.lat||!d.lng) return;
    const r=Math.max(5,Math.min(25,Math.sqrt((d.tpd||0)/maxTpd)*25));
    const color=REGION_COLORS[d.region]||'#00a99d';
    const marker=L.circleMarker([d.lat,d.lng],{radius:r,fillColor:color,color:'#fff',weight:1,opacity:0.8,fillOpacity:0.65});
    const conf=d.confidence==='verified'?'üü¢':'üü°';
    const yr=d.year_commissioned||'‚Äî';
    const designer=d.designer||'‚Äî';
    const safeName = (d.name||'').replace(/'/g,"\\'").replace(/"/g,'&quot;');
    marker.bindPopup(`
      <h4>${esc(d.name)}</h4>
      <div class="popup-row"><span class="popup-label">Company</span><span class="popup-val">${esc(d.company)||'‚Äî'}</span></div>
      <div class="popup-row"><span class="popup-label">Country</span><span class="popup-val">${esc(d.country)}</span></div>
      <div class="popup-row"><span class="popup-label">Region</span><span class="popup-val">${esc(d.region)}</span></div>
      <div class="popup-row"><span class="popup-label">Fill Type</span><span class="popup-val">${esc(d.type)}</span></div>
      <div class="popup-row"><span class="popup-label">Paste Capacity</span><span class="popup-val">${(d.tpd||0).toLocaleString()} tpd</span></div>
      <div class="popup-row"><span class="popup-label">Ore Throughput</span><span class="popup-val">${d.ore_tpd?(d.ore_tpd.toLocaleString()+' tpd'):'‚Äî'}</span></div>
      <div class="popup-row"><span class="popup-label">Commissioned</span><span class="popup-val">${yr}</span></div>
      <div class="popup-row"><span class="popup-label">Designer</span><span class="popup-val">${esc(designer)}</span></div>
      <div class="popup-row"><span class="popup-label">Status</span><span class="popup-val">${esc(d.status)||'‚Äî'}</span></div>
      <div class="popup-row"><span class="popup-label">Confidence</span><span class="popup-val">${conf} ${esc(d.confidence)||'‚Äî'}</span></div>
      <div class="popup-row"><span class="popup-label">Commodity</span><span class="popup-val">${esc(d.commodity)||'‚Äî'}</span></div>
      <div class="popup-row"><span class="popup-label">Source</span><span class="popup-val"><a href="${esc(d.source)}" target="_blank" style="font-size:11px">${esc(d.source_label)}</a></span></div>
      <a class="suggest-link" href="#" onclick="openCorrection('${safeName}');return false">üìù Suggest a correction</a>
    `,{maxWidth:300});
    clusterGroup.addLayer(marker);
  });
  map.addLayer(clusterGroup);
}

function renderStats(data){
  document.getElementById('totalMines').textContent=data.length;
  const total=data.reduce((s,d)=>s+(d.tpd||0),0);
  document.getElementById('totalTpd').textContent=total>=1e6?(total/1e6).toFixed(1)+'M':total>=1e3?(total/1e3).toFixed(0)+'K':total;
}

function renderCharts(data){
  const regionCounts={};
  data.forEach(d=>{regionCounts[d.region]=(regionCounts[d.region]||0)+1});
  const regionLabels=Object.keys(regionCounts).sort();
  makeChart('chartRegion','doughnut',regionLabels,regionLabels.map(r=>regionCounts[r]),regionLabels.map(r=>REGION_COLORS[r]||'#666'));

  const top10=[...data].sort((a,b)=>(b.tpd||0)-(a.tpd||0)).slice(0,10);
  makeChart('chartTop10','bar',top10.map(d=>d.name.length>20?d.name.slice(0,18)+'‚Ä¶':d.name),top10.map(d=>d.tpd||0),top10.map(d=>REGION_COLORS[d.region]||'#00a99d'),{indexAxis:'y',plugins:{legend:{display:false}}});

  const commCounts={};
  data.forEach(d=>{const c=(d.commodity||'unknown').split('/')[0];commCounts[c]=(commCounts[c]||0)+1});
  const commSorted=Object.entries(commCounts).sort((a,b)=>b[1]-a[1]);
  const topComm=commSorted.slice(0,8);
  const otherCount=commSorted.slice(8).reduce((s,e)=>s+e[1],0);
  if(otherCount>0) topComm.push(['other',otherCount]);
  const commColors=['#3498db','#e74c3c','#f39c12','#2ecc71','#9b59b6','#e67e22','#1abc9c','#34495e','#7f8c8d'];
  makeChart('chartCommodity','doughnut',topComm.map(c=>c[0]),topComm.map(c=>c[1]),commColors);

  const decades={};
  data.forEach(d=>{
    const y=d.year_commissioned;
    if(y){const dec=Math.floor(y/5)*5;decades[dec]=(decades[dec]||0)+1}
  });
  const decLabels=Object.keys(decades).sort();
  makeChart('chartTimeline','bar',decLabels.map(d=>d+'s'),decLabels.map(d=>decades[d]),'#00a99d',{plugins:{legend:{display:false}}});

  const statusCounts={};
  data.forEach(d=>{const s=d.status||'unknown';statusCounts[s]=(statusCounts[s]||0)+1});
  const statusLabels=Object.keys(statusCounts).sort();
  makeChart('chartStatus','doughnut',statusLabels,statusLabels.map(s=>statusCounts[s]),statusLabels.map(s=>STATUS_COLORS[s]||'#7f8c8d'));
}

function makeChart(id,type,labels,values,colors,extraOpts={}){
  if(charts[id]) charts[id].destroy();
  const ctx=document.getElementById(id).getContext('2d');
  const isBar=type==='bar';
  charts[id]=new Chart(ctx,{
    type,
    data:{
      labels,
      datasets:[{data:values,backgroundColor:Array.isArray(colors)?colors:colors,borderWidth:0,borderRadius:isBar?3:0}]
    },
    options:{
      responsive:true,maintainAspectRatio:true,
      plugins:{legend:{display:!isBar,position:'right',labels:{padding:6,font:{size:10}}}},
      scales:isBar?{x:{grid:{display:false}},y:{grid:{color:'#1a3f4a'}}}:undefined,
      ...extraOpts
    }
  });
}

// Modal
function openModal(prefill, isCorrection){
  const modal = document.getElementById('submitModal');
  modal.classList.add('active');
  // Reset
  document.querySelectorAll('#submitModal input, #submitModal textarea').forEach(el => { if(el.type!=='hidden') el.value = ''; });
  document.getElementById('fPlants').value = '1';
  document.getElementById('fSubmissionType').value = 'new';
  document.getElementById('correctionNote').style.display = 'none';
  document.getElementById('existingMineRow').style.display = 'none';
  document.getElementById('modalTitle').textContent = 'Submit a Mine';

  if(isCorrection && prefill){
    document.getElementById('fSubmissionType').value = 'correction';
    document.getElementById('fName').value = prefill;
    document.getElementById('fExistingMine').value = prefill;
    document.getElementById('correctionNote').style.display = 'block';
    document.getElementById('existingMineRow').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'Suggest a Correction';
  } else if(prefill){
    document.getElementById('fName').value = prefill;
  }
}

function closeModal(){document.getElementById('submitModal').classList.remove('active')}

function openCorrection(name){openModal(name, true)}

async function submitMine(){
  const name = document.getElementById('fName').value.trim();
  const submitter = document.getElementById('fSubmitter').value.trim();
  if(!name){alert('Mine name is required.');return}
  if(!submitter){alert('Your name is required.');return}

  const payload = {
    mine_name: name,
    company: document.getElementById('fCompany').value.trim() || null,
    country: document.getElementById('fCountry').value.trim() || null,
    fill_type: document.getElementById('fType').value,
    tpd: parseInt(document.getElementById('fTpd').value) || null,
    plants: parseInt(document.getElementById('fPlants').value) || 1,
    commodity: document.getElementById('fCommodity').value.trim() || null,
    commissioned_year: parseInt(document.getElementById('fYear').value) || null,
    lat: parseFloat(document.getElementById('fLat').value) || null,
    lng: parseFloat(document.getElementById('fLng').value) || null,
    notes: document.getElementById('fNotes').value.trim() || null,
    source_reference: document.getElementById('fSource').value.trim() || null,
    submitter_name: submitter,
    submitter_email: document.getElementById('fEmail').value.trim() || null,
    submission_type: document.getElementById('fSubmissionType').value,
    existing_mine_name: document.getElementById('fExistingMine').value.trim() || null
  };

  try {
    const res = await fetch(SUPABASE_URL + '/rest/v1/mine_submissions', {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const err = await res.text();
      throw new Error(err);
    }
    closeModal();
    showToast('Thanks! Your submission will be reviewed.');
  } catch(e) {
    alert('Error submitting: ' + e.message);
  }
}

function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 4000);
}

// Close modal on overlay click
document.getElementById('submitModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeModal()});
</script>
</body>
</html>
