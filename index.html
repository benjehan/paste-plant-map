<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<title>Global Paste Backfill Plant Map | MineSmart</title>
<meta name="description" content="Interactive map of 230+ paste backfill plants worldwide. Explore capacity, commodity, and regional data.">
<meta property="og:title" content="Global Paste Backfill Plant Map | MineSmart">
<meta property="og:description" content="Interactive map of 230+ paste backfill plants worldwide. Explore capacity, commodity, and regional data. A shared resource for the mining industry.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://pasteplant.minesmart.cloud">
<meta property="og:image" content="https://pasteplant.minesmart.cloud/og-image.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Global Paste Backfill Plant Map | MineSmart">
<meta name="twitter:description" content="Interactive map of 230+ paste backfill plants worldwide.">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a1a1f;--panel:#0d2329;--card:#112e36;--accent:#00a99d;--accent-glow:rgba(0,169,157,0.25);--brand:#004a59;--text:#e0e8ea;--muted:#7a9ca8;--border:#1a3f4a;--red:#e74c3c;--yellow:#f1c40f;--green:#2ecc71;--glass:rgba(13,35,41,0.85);--glass-border:rgba(0,169,157,0.2)}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh;display:flex;flex-direction:column}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}

/* Header */
.header{background:linear-gradient(135deg,var(--brand),#002a33);padding:8px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--accent);z-index:1000;flex-shrink:0}
.header-left{display:flex;align-items:center;gap:12px}
.header-left img{height:32px}
.header-left h1{font-size:18px;font-weight:600;letter-spacing:0.5px}
.header-right{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#fff;border:none;padding:7px 14px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
.btn:hover{background:#00c9b7;transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--accent);color:var(--accent)}
.btn-outline:hover{background:var(--accent);color:#fff}

/* Welcome popup */
.welcome-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:3000;display:flex;justify-content:center;align-items:center;backdrop-filter:blur(4px)}
.welcome-box{background:var(--panel);border:1px solid var(--accent);border-radius:12px;padding:28px;max-width:520px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.5)}

/* Header news */
.header-news{flex:1;text-align:center;overflow:hidden;padding:0 20px}
.header-news-item{opacity:0;transition:opacity 1.2s ease-in-out}
.header-news-item.active{opacity:1}
.header-news-tag{margin-right:8px}
.header-news-item a{color:var(--text);text-decoration:none;font-size:14px;font-weight:500}
.header-news-item a:hover{color:var(--accent);text-decoration:underline}

/* Main layout */
.main{display:flex;flex:1;overflow:hidden}
.map-container{flex:1;position:relative;min-width:0}
#map{width:100%;height:100%;background:var(--bg)}

/* Sidebar */
.sidebar{width:380px;background:var(--panel);overflow-y:auto;border-left:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column}
.sidebar::-webkit-scrollbar{width:6px}
.sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Backfill Pro banner */
.bp-banner{background:linear-gradient(135deg,#004a59,#006b70);padding:14px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--accent);cursor:pointer;transition:background .2s}
.bp-banner:hover{background:linear-gradient(135deg,#005a69,#007b80)}
.bp-banner .bp-icon{font-size:28px;flex-shrink:0}
.bp-banner .bp-text h3{font-size:14px;font-weight:600;color:#fff;margin-bottom:2px}
.bp-banner .bp-text p{font-size:11px;color:var(--muted)}
.bp-banner .bp-arrow{margin-left:auto;color:var(--accent);font-size:18px;flex-shrink:0}

/* Big stats cards */
.stats-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;padding:12px}
.stat-card{background:var(--card);border-radius:8px;padding:14px 10px;text-align:center;border:1px solid var(--border);transition:border-color .2s}
.stat-card:hover{border-color:var(--glass-border)}
.stat-card .value{font-size:22px;font-weight:700;color:var(--accent);line-height:1.2}
.stat-card .label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-top:4px}

/* Chart sections */
.chart-section{padding:8px 12px}
.chart-section h3{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:6px;border-bottom:1px solid var(--border);padding-bottom:4px}
.chart-wrap{position:relative;max-height:250px;overflow:visible}

/* News section */
.news-section{padding:8px 12px;border-top:1px solid var(--border)}
.news-section h3{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px;border-bottom:1px solid var(--border);padding-bottom:4px}
.news-item{padding:6px 0;border-bottom:1px solid var(--border)}
.news-item:last-child{border:none}
.news-item a{font-size:13px;font-weight:500;line-height:1.3;display:block}
.news-item .news-meta{font-size:10px;color:var(--muted);margin-top:2px}
.news-empty{font-size:12px;color:var(--muted);font-style:italic;padding:8px 0}

/* CTA */
.cta-section{padding:12px;display:flex;flex-direction:column;gap:6px;margin-top:auto}
.cta-section .btn{text-align:center;font-size:14px;padding:10px}

/* ============ FILTER BAR (Premium Redesign) ============ */
.filter-bar{position:absolute;top:10px;left:50px;right:10px;z-index:800;display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--glass-border);border-radius:12px;padding:12px 16px}

.filter-group{display:flex;flex-direction:column;gap:3px}
.filter-group label{font-size:10px;text-transform:uppercase;letter-spacing:0.8px;color:var(--muted);font-weight:600}

/* Search box */
.search-wrap{position:relative;flex:1;min-width:200px}
.search-wrap::before{content:'';position:absolute;left:13px;top:50%;width:13px;height:13px;margin-top:-8px;border:2px solid var(--muted);border-radius:50%;pointer-events:none;z-index:1}
.search-wrap::after{content:'';position:absolute;left:24px;top:50%;margin-top:3px;width:2px;height:7px;background:var(--muted);transform:rotate(-45deg);transform-origin:top;pointer-events:none;z-index:1}
.search-wrap input{width:100%;padding:9px 12px 9px 38px;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:8px;font-size:14px;transition:border-color .2s,box-shadow .2s}
.search-wrap input::placeholder{color:var(--muted)}
.search-wrap input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}

/* Custom selects */
.filter-bar select{appearance:none;-webkit-appearance:none;background:var(--card) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%237a9ca8'/%3E%3C/svg%3E") no-repeat right 10px center;color:var(--text);border:1px solid var(--border);padding:9px 30px 9px 12px;border-radius:8px;font-size:13px;cursor:pointer;min-width:120px;transition:border-color .2s,box-shadow .2s}
.filter-bar select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
.filter-bar select:hover{border-color:var(--accent)}

/* Clear filters */
.clear-filters{background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;padding:9px 8px;white-space:nowrap;transition:color .2s;align-self:flex-end}
.clear-filters:hover{color:var(--accent)}

/* Footer */
.footer{background:var(--brand);padding:6px 20px;font-size:11px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;border-top:1px solid var(--border)}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;justify-content:center;align-items:center}
.modal-overlay.active{display:flex}
.modal{background:var(--panel);border-radius:8px;padding:24px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}
.modal h2{margin-bottom:16px;font-size:18px;color:var(--accent)}
.modal label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px;text-transform:uppercase;letter-spacing:0.5px}
.modal input,.modal select,.modal textarea{width:100%;background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:4px;font-size:13px}
.modal textarea{height:60px;resize:vertical}
.modal input:focus,.modal select:focus,.modal textarea:focus{outline:none;border-color:var(--accent)}
.modal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}
.modal .close-btn{position:absolute;right:12px;top:12px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer}
.correction-note{background:var(--card);border:1px solid var(--yellow);border-radius:4px;padding:8px 10px;margin-bottom:8px;font-size:12px;color:var(--yellow);display:none}

/* Toast */
.toast{position:fixed;bottom:20px;right:20px;background:var(--green);color:#fff;padding:12px 20px;border-radius:6px;font-size:14px;font-weight:500;z-index:3000;display:none;box-shadow:0 4px 12px rgba(0,0,0,.4)}

/* Leaflet overrides */
.leaflet-popup-content-wrapper{background:var(--card);color:var(--text);border-radius:6px;border:1px solid var(--border)}
.leaflet-popup-tip{background:var(--card)}
.leaflet-popup-content{margin:0;font-size:13px;line-height:1.5;min-width:260px;max-width:320px}
.popup-header{padding:12px 14px 8px}
.popup-mine-name{font-size:16px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:6px}
.popup-company{font-size:12px;color:var(--muted);margin-top:2px}
.popup-badges{display:flex;flex-wrap:wrap;gap:5px;padding:6px 14px 8px}
.popup-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;line-height:1.4}
.popup-badge.capacity{background:rgba(0,169,157,0.2);color:var(--accent)}
.popup-badge.commodity{background:rgba(52,152,219,0.2);color:#3498db}
.popup-badge.status-operating{background:rgba(46,204,113,0.15);color:var(--green)}
.popup-badge.status-closed{background:rgba(231,76,60,0.15);color:var(--red)}
.popup-badge.status-other{background:rgba(241,196,15,0.15);color:var(--yellow)}
.popup-badge.fill-paste{background:rgba(0,169,157,0.2);color:#00a99d}
.popup-badge.fill-caf{background:rgba(155,89,182,0.2);color:#9b59b6}
.popup-badge.fill-hydraulic{background:rgba(52,152,219,0.2);color:#3498db}
.popup-badge.fill-crf{background:rgba(230,126,34,0.2);color:#e67e22}
.popup-badge.fill-multiple{background:rgba(241,196,15,0.2);color:#f1c40f}
.popup-grid{display:grid;grid-template-columns:auto 1fr;gap:2px 12px;padding:6px 14px 10px;font-size:12px}
.popup-grid .pg-label{color:var(--muted);white-space:nowrap}
.popup-grid .pg-val{font-weight:500;text-align:right}
.popup-source{padding:4px 14px 6px;border-top:1px solid var(--border);font-size:11px}
.popup-source a{color:var(--accent)}
.popup-footer{padding:6px 14px 10px;border-top:1px solid var(--border);font-size:11px;color:var(--muted)}
.popup-footer .suggest-link{display:inline-block;margin-top:4px;color:var(--accent);font-size:11px}
.leaflet-control-zoom a{background:var(--card)!important;color:var(--text)!important;border-color:var(--border)!important}
.marker-cluster{background:rgba(0,169,157,0.3)!important}
.marker-cluster div{background:rgba(0,169,157,0.7)!important;color:#fff!important;font-weight:600}

/* Sidebar toggle button */
/* Floating add button */
.fab-add{position:absolute;bottom:30px;right:14px;z-index:900;width:44px;height:44px;border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:20px;line-height:1;cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.5);transition:transform .2s,background .2s;display:flex;align-items:center;justify-content:center}
.fab-add:hover{background:#00c9b7;transform:scale(1.1)}

.sidebar-toggle{display:none;position:absolute;bottom:90px;left:10px;z-index:900;width:48px;height:48px;border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:22px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.4);transition:transform .2s}
.sidebar-toggle:hover{transform:scale(1.1)}

/* Hamburger */
.hamburger{display:none;background:none;border:1px solid var(--accent);color:var(--accent);font-size:22px;padding:4px 10px;border-radius:4px;cursor:pointer}
.mobile-menu{display:none;position:absolute;top:100%;right:0;background:var(--panel);border:1px solid var(--border);border-radius:0 0 6px 6px;padding:8px;z-index:1001;flex-direction:column;gap:6px;min-width:180px}
.mobile-menu.open{display:flex}
.header{position:relative}

/* Filter toggle (mobile) */
.filter-toggle{display:none;position:absolute;top:10px;left:10px;z-index:801;background:var(--glass);color:var(--text);border:1px solid var(--glass-border);padding:10px 14px;border-radius:8px;font-size:13px;cursor:pointer;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);font-weight:500}

/* Smooth sidebar transitions */
.sidebar{transition:transform .3s ease, opacity .3s ease}

/* Tablet */
@media(max-width:1024px){
  .sidebar{width:300px}
  .stats-row{grid-template-columns:1fr 1fr}
}

/* Mobile */
@media(max-width:767px){
  .header-left h1{font-size:13px}
  .header-news{display:none!important}
  .header-right{display:none}
  .hamburger{display:block}
  
  .main{flex-direction:column;position:relative}
  .map-container{flex:1;height:100%}
  
  /* Sidebar as bottom sheet */
  .sidebar{position:absolute;bottom:0;left:0;right:0;width:100%!important;max-height:60vh;border-left:none;border-top:2px solid var(--accent);border-radius:12px 12px 0 0;z-index:850;transform:translateY(100%);opacity:0;pointer-events:none}
  .sidebar.open{transform:translateY(0);opacity:1;pointer-events:auto}
  
  .sidebar-toggle{display:flex;align-items:center;justify-content:center}
  .sidebar.open~.map-container .sidebar-toggle,.sidebar-toggle.active{bottom:calc(60vh + 20px)}
  
  /* Stats row 2-col on mobile */
  .stats-row{grid-template-columns:1fr 1fr;gap:6px;padding:8px}
  .stat-card .value{font-size:18px}
  
  /* Charts */
  .chart-section{padding:6px 10px}
  .chart-wrap{max-height:200px}
  
  /* Filter bar */
  .filter-bar{flex-direction:column;left:10px;right:10px;top:10px;display:none;gap:6px;align-items:stretch}
  .filter-bar.open{display:flex}
  .filter-bar select,.search-wrap input{width:100%;min-width:0;padding:12px 14px 12px 40px;font-size:14px}
  .filter-bar select{padding-left:12px}
  .filter-group{width:100%}
  .search-wrap{min-width:0}
  .filter-toggle{display:block}
  
  /* Popups */
  .leaflet-popup-content{min-width:200px;max-width:280px}
  
  /* Modal full screen */
  .modal{width:100%;max-width:100%;height:100vh;max-height:100vh;border-radius:0;padding:16px}
  .modal input,.modal select,.modal textarea{padding:12px;font-size:15px}
  .modal label{margin:10px 0 4px}
  
  /* Touch targets */
  .btn{padding:12px 16px;font-size:14px;min-height:44px}
  select,input,textarea{min-height:44px}
  
  /* Footer */
  .footer{padding:6px 10px;font-size:10px;flex-wrap:wrap;justify-content:center;text-align:center}
  
  /* Disclaimer */
  .sidebar>div:first-child{font-size:11px;padding:10px}
  
  /* CTA */
  .cta-section .btn{padding:14px;font-size:15px}
}

/* Header signup */
/* Subscribe modal */
.subscribe-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:2000;justify-content:center;align-items:center;backdrop-filter:blur(4px)}
.subscribe-overlay.active{display:flex}
.subscribe-modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:28px;width:90%;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,.5);position:relative}
.subscribe-modal h2{color:var(--accent);font-size:18px;margin-bottom:4px}
.subscribe-modal p{color:var(--muted);font-size:12px;margin-bottom:16px}
.subscribe-modal input{width:100%;background:var(--card);color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:6px;font-size:14px;margin-bottom:10px}
.subscribe-modal input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
.subscribe-modal input::placeholder{color:var(--muted)}
.subscribe-modal .btn{width:100%;text-align:center;padding:11px;font-size:14px}
.subscribe-modal .close-btn{position:absolute;right:12px;top:12px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer}

/* Compare Regions modal */
.compare-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;justify-content:center;align-items:center;padding:20px}
.compare-overlay.active{display:flex}
.compare-modal{background:var(--panel);border-radius:12px;padding:24px;width:95%;max-width:900px;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}
.compare-modal h2{font-size:18px;color:var(--accent);margin-bottom:6px}
.compare-modal p{font-size:12px;color:var(--muted);margin-bottom:16px}
.compare-modal .close-btn{float:right;background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer}
.region-selector{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px}
.region-chip{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:var(--card);color:var(--muted);cursor:pointer;font-size:13px;transition:all .2s}
.region-chip.selected{background:var(--accent);color:#fff;border-color:var(--accent)}
.region-chip:hover{border-color:var(--accent)}
.compare-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:20px}
.compare-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px}
.compare-card h4{font-size:15px;color:var(--accent);margin-bottom:10px}
.compare-card .cc-row{display:flex;justify-content:space-between;font-size:12px;padding:4px 0;border-bottom:1px solid var(--border)}
.compare-card .cc-row:last-child{border:none}
.compare-card .cc-label{color:var(--muted)}
.compare-card .cc-val{font-weight:600}
.compare-chart-wrap{max-height:300px;margin-top:16px}

/* Desktop */
@media(min-width:1025px){
  .sidebar{width:380px}
}

@media(max-width:767px){
  .compare-modal{width:100%;max-width:100%;border-radius:0;padding:16px}
  .compare-cards{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <img src="https://minesmart.io/wp-content/uploads/2023/03/MineSmart-Logo-White.png" alt="MineSmart" onerror="this.style.display='none'">
    <h1>Global Paste Backfill Plant Map</h1>
  </div>
  <div class="header-news" id="headerNews" style="display:none">
    <div class="header-news-item" id="headerNewsItem">
      <span class="header-news-tag">üì∞</span>
      <a id="headerNewsLink" href="#" target="_blank"></a>
    </div>
  </div>
  <div class="header-right">
    <button class="btn btn-outline" onclick="openSubscribeModal()">Stay Updated</button>
    <a href="https://minesmart.io/backfill-pro/" target="_blank" class="btn">Request a Demo</a>
  </div>
  <button class="hamburger" onclick="document.querySelector('.mobile-menu').classList.toggle('open')" aria-label="Menu">‚ò∞</button>
  <div class="mobile-menu">
    <button class="btn btn-outline" onclick="openSubscribeModal();document.querySelector('.mobile-menu').classList.remove('open')" style="width:100%;text-align:center">Stay Updated</button>
    <a href="https://minesmart.io/backfill-pro/" target="_blank" class="btn">Request a Demo</a>
  </div>
</div>

<div class="main">
  <div class="map-container">
    <button class="filter-toggle" onclick="document.querySelector('.filter-bar').classList.toggle('open');this.textContent=document.querySelector('.filter-bar').classList.contains('open')?'‚úï Close Filters':'üîç Filters'">üîç Filters</button>
    <div class="filter-bar">
      <div class="filter-group search-wrap" style="flex:1;min-width:200px">
        <label>Search</label>
        <input type="text" id="searchBox" placeholder="Search mines, companies, countries...">
      </div>
      <div class="filter-group">
        <label>Region</label>
        <select id="filterRegion"><option value="">All Regions</option></select>
      </div>
      <div class="filter-group">
        <label>Commodity</label>
        <select id="filterCommodity"><option value="">All Commodities</option></select>
      </div>
      <div class="filter-group">
        <label>Status</label>
        <select id="filterStatus"><option value="">All Statuses</option></select>
      </div>
      <div class="filter-group">
        <label>Fill Type</label>
        <select id="filterFillType"><option value="">All Types</option><option value="Paste">Paste</option><option value="CAF">CAF</option><option value="Hydraulic Fill">Hydraulic Fill</option><option value="CRF">CRF</option><option value="Multiple">Multiple</option></select>
      </div>
      <div class="filter-group">
        <label>Confidence</label>
        <select id="filterConfidence"><option value="" selected>All Confidence</option><option value="verified">Verified Only</option><option value="likely">Likely</option></select>
      </div>
      <button class="clear-filters" id="clearFiltersBtn" onclick="clearFilters()" style="display:none">‚úï Clear filters</button>
    </div>
    <div id="map"></div>
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">üìä</button>
    <button class="fab-add" onclick="openModal()" aria-label="Submit a Mine" title="Submit a Mine">üìç</button>
  </div>

  <div class="sidebar">
    <!-- Intro removed from sidebar, now a welcome popup -->

    <!-- Big stats -->
    <div class="stats-row">
      <div class="stat-card"><div class="value" id="totalMines">‚Äî</div><div class="label">Plants</div></div>
      <div class="stat-card"><div class="value" id="totalTpd">‚Äî</div><div class="label">Total TPD</div></div>
      <div class="stat-card"><div class="value" id="totalCountries">‚Äî</div><div class="label">Countries</div></div>
      <div class="stat-card"><div class="value" id="totalCompanies">‚Äî</div><div class="label">Companies</div></div>
    </div>

    <!-- Charts in new order -->
    <div class="chart-section">
      <h3>By Region</h3>
      <div class="chart-wrap"><canvas id="chartRegion"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Capacity by Region (tpd)</h3>
      <div class="chart-wrap" style="max-height:220px"><canvas id="chartRegionCapacity"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Top 10 by Capacity (tpd)</h3>
      <div class="chart-wrap" style="max-height:220px"><canvas id="chartTop10"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Top 10 Companies (by # of plants)</h3>
      <div class="chart-wrap" style="max-height:220px"><canvas id="chartTopCompanies"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Primary Commodity</h3>
      <div class="chart-wrap"><canvas id="chartCommodity"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Commissioning Timeline</h3>
      <div class="chart-wrap"><canvas id="chartTimeline"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Status</h3>
      <div class="chart-wrap" style="min-height:180px"><canvas id="chartStatus"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Fill Type</h3>
      <div class="chart-wrap" style="min-height:180px"><canvas id="chartFillType"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Avg Plant Size by Region (tpd)</h3>
      <div class="chart-wrap" style="max-height:220px"><canvas id="chartAvgSize"></canvas></div>
    </div>

    <div class="chart-section" id="designerSection" style="display:none">
      <h3>Designer Breakdown</h3>
      <div class="chart-wrap"><canvas id="chartDesigner"></canvas></div>
    </div>

    <!-- News section -->
    <div class="news-section">
      <h3>üì∞ Industry News</h3>
      <div id="newsFeed"><div class="news-empty">Loading news...</div></div>
    </div>

    <!-- Compare Regions -->
    <div style="padding:8px 12px">
      <button class="btn btn-outline" style="width:100%;text-align:center" onclick="openCompareModal()">üìä Compare Regions</button>
    </div>

    <div class="cta-section">
      <a href="https://minesmart.io/backfill-pro/" target="_blank" class="btn">Learn about Backfill Pro</a>
    </div>
  </div>
</div>

<div class="footer">
  <span>Powered by <a href="https://minesmart.io" target="_blank">MineSmart Solutions Ltd</a> | <strong>Backfill Pro</strong> ‚Äî Paste Operations Management Platform</span>
  <span></span>
</div>

<!-- Submit Modal -->
<div class="modal-overlay" id="submitModal">
  <div class="modal" style="position:relative">
    <button class="close-btn" onclick="closeModal()">&times;</button>
    <h2 id="modalTitle">Submit a Mine</h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Know of a paste backfill plant not on the map? Submit it here.</p>
    <div class="correction-note" id="correctionNote">üìù You are suggesting a correction for an existing mine.</div>
    <input type="hidden" id="fSubmissionType" value="new">
    <label>Mine Name *</label><input id="fName" required>
    <div id="existingMineRow" style="display:none">
      <label>Existing Mine Name (if correcting)</label><input id="fExistingMine">
    </div>
    <label>Company</label><input id="fCompany">
    <label>Country</label><input id="fCountry">
    <label>Fill Type</label>
    <select id="fType"><option>Paste</option><option>Cemented Paste</option><option>Thickened Tailings</option><option>Other</option></select>
    <label>Paste Capacity (tpd)</label><input id="fTpd" type="number">
    <label>Number of Plants</label><input id="fPlants" type="number" value="1">
    <label>Year Commissioned</label><input id="fYear" type="number">
    <label>Year Decommissioned</label><input id="fYearDecom" type="number" placeholder="Leave blank if active">
    <label>Primary Commodity</label><input id="fCommodity">
    <label>Latitude</label><input id="fLat" type="number" step="any" placeholder="e.g. -33.8688">
    <label>Longitude</label><input id="fLng" type="number" step="any" placeholder="e.g. 151.2093">
    <label>Notes</label><textarea id="fNotes" placeholder="Any additional details..."></textarea>
    <label>Your Name *</label><input id="fSubmitter" required>
    <label>Your Email</label><input id="fEmail" type="email">
    <label>Source / Reference</label><textarea id="fSource"></textarea>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn" onclick="submitMine()">Submit</button>
    </div>
  </div>
</div>

<!-- Compare Regions Modal -->
<div class="compare-overlay" id="compareOverlay" onclick="if(event.target===this)closeCompareModal()">
  <div class="compare-modal">
    <button class="close-btn" onclick="closeCompareModal()">&times;</button>
    <h2>üìä Compare Regions</h2>
    <p>Select 2‚Äì3 regions to compare side by side</p>
    <div class="region-selector" id="regionSelector"></div>
    <div class="compare-cards" id="compareCards"></div>
    <div class="compare-chart-wrap"><canvas id="compareChart"></canvas></div>
  </div>
</div>

<!-- Welcome popup -->
<div class="welcome-overlay" id="welcomeOverlay">
  <div class="welcome-box">
    <h2 style="color:var(--accent);margin-bottom:12px;font-size:20px">üåç Welcome to the Global Paste Plant Map</h2>
    <p style="color:var(--text);font-size:14px;line-height:1.6;margin-bottom:10px">This map aims to chart the global paste backfill ecosystem ‚Äî <strong>a shared resource for the entire industry</strong>. It is live and continuously updated as new data becomes available.</p>
    <p style="color:var(--muted);font-size:13px;line-height:1.6;margin-bottom:16px">While we strive for accuracy, some data may be incomplete or evolving. If you spot something that needs correcting or know of a plant not listed, please submit an update with a source ‚Äî every contribution helps make this resource better for everyone.</p>
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);cursor:pointer">
        <input type="checkbox" id="welcomeDontShow" style="accent-color:var(--accent);width:16px;height:16px"> Don't show this again
      </label>
      <button class="btn" id="welcomeGotIt" style="padding:10px 24px;font-size:14px">Got it</button>
    </div>
  </div>
</div>

<!-- Subscribe Modal -->
<div class="subscribe-overlay" id="subscribeModal" onclick="if(event.target===this)closeSubscribeModal()">
  <div class="subscribe-modal">
    <button class="close-btn" onclick="closeSubscribeModal()">&times;</button>
    <h2>üìß Stay Updated</h2>
    <p>Get notified when new plants are added or major updates are made to the map.</p>
    <input id="subName" placeholder="Your name">
    <input id="subEmail" type="email" placeholder="Your email *" required>
    <button class="btn" onclick="submitSubscribe()">Subscribe</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SUPABASE_URL = 'https://cxsariervcthxoudumaq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4c2FyaWVydmN0aHhvdWR1bWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTcwMTAsImV4cCI6MjA4Nzc3MzAxMH0.KmjcyBRtRRgvg4FZarJ935wjcKZ4PTThszKWbFPzwUY';

const REGION_COLORS = {
  'North America':'#3498db','South America':'#e74c3c','Europe':'#f39c12',
  'Africa':'#9b59b6','Asia':'#1abc9c','Australia':'#e67e22'
};
const FILL_TYPE_COLORS = {
  'Paste':'#00a99d','CAF':'#9b59b6','Hydraulic Fill':'#3498db','CRF':'#e67e22','Multiple':'#f1c40f'
};
function fillBadgeClass(ft){return 'fill-'+(ft||'paste').toLowerCase().replace(/ .*/,'')}

const STATUS_COLORS = {
  'operating':'#2ecc71','closed':'#e74c3c','care & maintenance':'#f39c12',
  'planned':'#3498db','under construction':'#9b59b6','commissioning 2026':'#1abc9c','':'#7f8c8d'
};

let allData=[], map, clusterGroup, charts={};

// Chart.js defaults
Chart.defaults.color='#7a9ca8';
Chart.defaults.borderColor='#1a3f4a';
Chart.defaults.font.size=11;
Chart.defaults.plugins.legend.labels.boxWidth=10;
Chart.defaults.animation.duration=800;

fetch(SUPABASE_URL + '/rest/v1/mines?select=*', {
  headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY }
}).then(r=>{if(!r.ok)throw new Error('API error');return r.json()}).then(data=>{
  allData=data;
  populateFilters(data);
  initMap();
  applyFilters();
}).catch(e=>{
  console.error('Failed to load from Supabase, falling back to data.json:', e);
  fetch('data.json').then(r=>r.json()).then(data=>{
    allData=data;
    populateFilters(data);
    initMap();
    applyFilters();
  });
});

loadNews();

async function loadNews() {
  try {
    const res = await fetch(SUPABASE_URL + '/rest/v1/paste_news?order=published_at.desc&limit=8', {
      headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY }
    });
    if (!res.ok) throw new Error('API error');
    const news = await res.json();
    const container = document.getElementById('newsFeed');
    if (!news.length) { container.innerHTML = '<div class="news-empty">News feed coming soon...</div>'; return; }
    container.innerHTML = news.map(n => {
      const date = n.published_at ? new Date(n.published_at).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'}) : '';
      return `<div class="news-item"><a href="${esc(n.url)}" target="_blank">${esc(n.title)}</a><div class="news-meta">${n.source ? esc(n.source) + ' ¬∑ ' : ''}${date}</div></div>`;
    }).join('');
    if(news.length) {
      const headerNews = document.getElementById('headerNews');
      const newsItem = document.getElementById('headerNewsItem');
      const newsLink = document.getElementById('headerNewsLink');
      headerNews.style.display = 'block';
      let idx = 0;
      function showNews() {
        newsItem.classList.remove('active');
        setTimeout(() => { newsLink.textContent = news[idx].title; newsLink.href = news[idx].url; newsItem.classList.add('active'); idx = (idx + 1) % news.length; }, 1200);
      }
      showNews(); newsItem.classList.add('active');
      setInterval(showNews, 12000);
    }
  } catch(e) { document.getElementById('newsFeed').innerHTML = '<div class="news-empty">News feed coming soon...</div>'; }
}

function esc(s) { const d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }

function populateFilters(data){
  const add=(id,vals)=>{const s=document.getElementById(id);vals.forEach(v=>{if(v){const o=document.createElement('option');o.value=v;o.textContent=v;s.appendChild(o)}})};
  add('filterRegion',[...new Set(data.map(d=>d.region))].sort());
  add('filterCommodity',[...new Set(data.map(d=>(d.commodity||'').split('/')[0]).filter(Boolean))].sort());
  add('filterStatus',[...new Set(data.map(d=>d.status).filter(Boolean))].sort());
  document.querySelectorAll('.filter-bar select, .filter-bar input').forEach(el=>el.addEventListener('input',applyFilters));
}

function clearFilters(){
  document.getElementById('searchBox').value='';
  document.getElementById('filterRegion').value='';
  document.getElementById('filterCommodity').value='';
  document.getElementById('filterStatus').value='';
  document.getElementById('filterFillType').value='';
  document.getElementById('filterConfidence').value='';
  applyFilters();
}

function applyFilters(){
  const region=document.getElementById('filterRegion').value;
  const commodity=document.getElementById('filterCommodity').value;
  const status=document.getElementById('filterStatus').value;
  const fillType=document.getElementById('filterFillType').value;
  const confidence=document.getElementById('filterConfidence').value;
  const search=document.getElementById('searchBox').value.toLowerCase();
  const filtered=allData.filter(d=>{
    if(region && d.region!==region) return false;
    if(commodity && !(d.commodity||'').toLowerCase().includes(commodity.toLowerCase())) return false;
    if(status && d.status!==status) return false;
    if(fillType && (d.fill_type||'Paste')!==fillType) return false;
    if(confidence && d.confidence!==confidence) return false;
    if(search && !d.name.toLowerCase().includes(search) && !(d.company||'').toLowerCase().includes(search) && !(d.country||'').toLowerCase().includes(search)) return false;
    return true;
  });
  renderAll(filtered);
  if(clusterGroup && clusterGroup.getLayers().length){
    map.fitBounds(clusterGroup.getBounds().pad(0.1));
  }
  const hasFilters = region || commodity || status || fillType || confidence || search;
  document.getElementById('clearFiltersBtn').style.display = hasFilters ? 'block' : 'none';
}

function initMap(){
  map=L.map('map',{zoomControl:true,attributionControl:false,worldCopyJump:true,minZoom:2,maxZoom:18}).setView([20,0],2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:18}).addTo(map);
  L.control.attribution({prefix:false,position:'bottomright'}).addAttribution('¬© <a href="https://carto.com">CARTO</a> ¬© <a href="https://osm.org">OSM</a>').addTo(map);
}

function renderAll(data){
  renderMap(data);
  renderStats(data);
  renderCharts(data);
}

function renderMap(data){
  if(clusterGroup) map.removeLayer(clusterGroup);
  clusterGroup=L.markerClusterGroup({maxClusterRadius:40,spiderfyOnMaxZoom:true});
  const maxTpd=Math.max(...data.map(d=>d.tpd||0),1);
  data.forEach(d=>{
    if(!d.lat||!d.lng) return;
    const r=Math.max(5,Math.min(25,Math.sqrt((d.tpd||0)/maxTpd)*25));
    const color=REGION_COLORS[d.region]||'#00a99d';
    const marker=L.circleMarker([d.lat,d.lng],{radius:r,fillColor:color,color:'#fff',weight:1,opacity:0.8,fillOpacity:0.65});
    const conf=d.confidence==='verified'?'üü¢':'üü°';
    const yr=d.year_commissioned||'‚Äî';
    const designer=d.designer||'‚Äî';
    const safeName = (d.name||'').replace(/'/g,"\\'").replace(/"/g,'&quot;');
    const statusClass = (d.status||'').toLowerCase()==='operating'?'status-operating':(d.status||'').toLowerCase()==='closed'?'status-closed':'status-other';
    marker.bindPopup(`
      <div class="popup-header">
        <div class="popup-mine-name">${conf} ${esc(d.name)}</div>
        <div class="popup-company">${esc(d.company)||'‚Äî'}</div>
      </div>
      <div class="popup-badges">
        <span class="popup-badge capacity">${(d.tpd||0).toLocaleString()} tpd</span>
        <span class="popup-badge ${fillBadgeClass(d.fill_type)}">${esc(d.fill_type||'Paste')}</span>
        ${d.commodity?'<span class="popup-badge commodity">'+esc(d.commodity)+'</span>':''}
        ${d.status?'<span class="popup-badge '+statusClass+'">'+esc(d.status)+'</span>':''}
      </div>
      <div class="popup-grid">
        <span class="pg-label">Country</span><span class="pg-val">${esc(d.country)}</span>
        <span class="pg-label">Region</span><span class="pg-val">${esc(d.region)}</span>
        <span class="pg-label">Fill Type</span><span class="pg-val">${esc(d.fill_type||'Paste')}</span>
        <span class="pg-label">Plants</span><span class="pg-val">${d.plants||'‚Äî'}</span>
        <span class="pg-label">Ore TPD</span><span class="pg-val">${d.ore_tpd?(d.ore_tpd.toLocaleString()):'‚Äî'}</span>
        <span class="pg-label">Designer</span><span class="pg-val">${esc(designer)}</span>
        <span class="pg-label">Commissioned</span><span class="pg-val">${yr}</span>
        ${d.year_decommissioned?'<span class="pg-label">Decommissioned</span><span class="pg-val" style="color:var(--red)">'+d.year_decommissioned+'</span>':''}
      </div>
      ${d.source?'<div class="popup-source">üìé <a href="'+encodeURI(d.source)+'" target="_blank" rel="noopener">'+esc(d.source_label||'View source')+' ‚Üí</a></div>':''}
      <div class="popup-footer">
        ${d.last_updated?'<div style="margin-bottom:4px;font-size:11px;color:var(--muted)">‚úÖ Last checked '+d.last_updated+(d.updated_by?' by <strong style="color:var(--text)">'+esc(d.updated_by)+'</strong>':'')+'</div>':''}
        <a class="suggest-link" href="#" onclick="openCorrection('${safeName}');return false">üìù Suggest a correction</a>
      </div>
    `,{maxWidth:320,autoPan:true,autoPanPadding:[40,40]});
    clusterGroup.addLayer(marker);
  });
  map.addLayer(clusterGroup);
  if(clusterGroup.getLayers().length) map.fitBounds(clusterGroup.getBounds().pad(0.05));
}

function fmtNum(n){
  if(n>=1e6) return (n/1e6).toFixed(1)+'M';
  if(n>=1e3) return (n/1e3).toFixed(0)+'K';
  return n.toString();
}

function renderStats(data){
  document.getElementById('totalMines').textContent=data.length;
  const total=data.reduce((s,d)=>s+(d.tpd||0),0);
  document.getElementById('totalTpd').textContent=fmtNum(total);
  const countries=new Set(data.map(d=>d.country).filter(Boolean));
  document.getElementById('totalCountries').textContent=countries.size;
  const companies=new Set(data.map(d=>d.company).filter(Boolean));
  document.getElementById('totalCompanies').textContent=companies.size;
}

function renderCharts(data){
  // 1. By Region (doughnut)
  const regionCounts={};
  data.forEach(d=>{regionCounts[d.region]=(regionCounts[d.region]||0)+1});
  const regionLabels=Object.keys(regionCounts).sort();
  makeChart('chartRegion','doughnut',regionLabels,regionLabels.map(r=>regionCounts[r]),regionLabels.map(r=>REGION_COLORS[r]||'#666'));

  // 2. Capacity by Region (bar)
  const regionTpd={};
  data.forEach(d=>{regionTpd[d.region]=(regionTpd[d.region]||0)+(d.tpd||0)});
  const rCapLabels=Object.keys(regionTpd).sort((a,b)=>regionTpd[b]-regionTpd[a]);
  makeChart('chartRegionCapacity','bar',rCapLabels,rCapLabels.map(r=>regionTpd[r]),rCapLabels.map(r=>REGION_COLORS[r]||'#00a99d'),{indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{ticks:{callback:v=>fmtNum(v)}},y:{grid:{display:false}}}});

  // 3. Top 10 by Capacity
  const top10=[...data].sort((a,b)=>(b.tpd||0)-(a.tpd||0)).slice(0,10);
  makeChart('chartTop10','bar',top10.map(d=>d.name.length>20?d.name.slice(0,18)+'‚Ä¶':d.name),top10.map(d=>d.tpd||0),top10.map(d=>REGION_COLORS[d.region]||'#00a99d'),{indexAxis:'y',plugins:{legend:{display:false}}});

  // 4. Top 10 Companies by # of plants
  const companyCounts={};
  data.forEach(d=>{if(d.company) companyCounts[d.company]=(companyCounts[d.company]||0)+1});
  const topCo=Object.entries(companyCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  makeChart('chartTopCompanies','bar',topCo.map(c=>c[0].length>22?c[0].slice(0,20)+'‚Ä¶':c[0]),topCo.map(c=>c[1]),'#00a99d',{indexAxis:'y',plugins:{legend:{display:false}}});

  // 5. Primary Commodity (doughnut)
  const commCounts={};
  data.forEach(d=>{const c=(d.commodity||'unknown').split('/')[0];commCounts[c]=(commCounts[c]||0)+1});
  const commSorted=Object.entries(commCounts).sort((a,b)=>b[1]-a[1]);
  const topComm=commSorted.slice(0,8);
  const otherCount=commSorted.slice(8).reduce((s,e)=>s+e[1],0);
  if(otherCount>0) topComm.push(['other',otherCount]);
  const commColors=['#3498db','#e74c3c','#f39c12','#2ecc71','#9b59b6','#e67e22','#1abc9c','#34495e','#7f8c8d'];
  makeChart('chartCommodity','doughnut',topComm.map(c=>c[0]),topComm.map(c=>c[1]),commColors);

  // 6. Commissioning Timeline
  const decades={};
  data.forEach(d=>{
    const y=d.year_commissioned;
    if(y){const dec=Math.floor(y/5)*5;decades[dec]=(decades[dec]||0)+1}
  });
  const decLabels=Object.keys(decades).sort();
  makeChart('chartTimeline','bar',decLabels.map(d=>d+'s'),decLabels.map(d=>decades[d]),'#00a99d',{plugins:{legend:{display:false}}});

  // 7. Status (doughnut)
  const statusCounts={};
  data.forEach(d=>{const s=d.status||'unknown';statusCounts[s]=(statusCounts[s]||0)+1});
  const statusLabels=Object.keys(statusCounts).sort();
  makeChart('chartStatus','doughnut',statusLabels,statusLabels.map(s=>statusCounts[s]),statusLabels.map(s=>STATUS_COLORS[s]||'#7f8c8d'));

  // 8. Fill Type (doughnut)
  const fillCounts={};
  data.forEach(d=>{const ft=d.fill_type||'Paste';fillCounts[ft]=(fillCounts[ft]||0)+1});
  const fillLabels=Object.keys(fillCounts).sort((a,b)=>fillCounts[b]-fillCounts[a]);
  makeChart('chartFillType','doughnut',fillLabels,fillLabels.map(f=>fillCounts[f]),fillLabels.map(f=>FILL_TYPE_COLORS[f]||'#7f8c8d'));

  // 9. Average Plant Size by Region
  const regionCount2={}, regionTpd2={};
  data.forEach(d=>{
    if(d.tpd){
      regionCount2[d.region]=(regionCount2[d.region]||0)+1;
      regionTpd2[d.region]=(regionTpd2[d.region]||0)+d.tpd;
    }
  });
  const avgLabels=Object.keys(regionTpd2).sort((a,b)=>(regionTpd2[b]/regionCount2[b])-(regionTpd2[a]/regionCount2[a]));
  makeChart('chartAvgSize','bar',avgLabels,avgLabels.map(r=>Math.round(regionTpd2[r]/regionCount2[r])),avgLabels.map(r=>REGION_COLORS[r]||'#00a99d'),{indexAxis:'y',plugins:{legend:{display:false}}});

  // 9. Designer breakdown (if data exists)
  const designerCounts={};
  data.forEach(d=>{if(d.designer) designerCounts[d.designer]=(designerCounts[d.designer]||0)+1});
  const designerEntries=Object.entries(designerCounts).sort((a,b)=>b[1]-a[1]);
  if(designerEntries.length>0){
    document.getElementById('designerSection').style.display='block';
    const dColors=['#00a99d','#3498db','#e74c3c','#f39c12','#9b59b6','#e67e22','#2ecc71','#1abc9c'];
    makeChart('chartDesigner','doughnut',designerEntries.map(d=>d[0]),designerEntries.map(d=>d[1]),dColors);
  }
}

function makeChart(id,type,labels,values,colors,extraOpts={}){
  if(charts[id]) charts[id].destroy();
  const ctx=document.getElementById(id).getContext('2d');
  const isBar=type==='bar';
  const mergedScales = extraOpts.scales || (isBar?{x:{grid:{display:false}},y:{grid:{color:'#1a3f4a'}}}:undefined);
  const mergedPlugins = {...{legend:{display:!isBar,position:'right',labels:{padding:4,font:{size:10},boxWidth:8}}}, ...(extraOpts.plugins||{})};
  charts[id]=new Chart(ctx,{
    type,
    data:{
      labels,
      datasets:[{data:values,backgroundColor:Array.isArray(colors)?colors:colors,borderWidth:0,borderRadius:isBar?3:0}]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:mergedPlugins,
      scales:mergedScales,
      indexAxis:extraOpts.indexAxis||undefined
    }
  });
}

// Modal
function openModal(prefill, isCorrection){
  const modal = document.getElementById('submitModal');
  modal.classList.add('active');
  document.querySelectorAll('#submitModal input, #submitModal textarea').forEach(el => { if(el.type!=='hidden') el.value = ''; });
  document.getElementById('fPlants').value = '1';
  document.getElementById('fSubmissionType').value = 'new';
  document.getElementById('correctionNote').style.display = 'none';
  document.getElementById('existingMineRow').style.display = 'none';
  document.getElementById('modalTitle').textContent = 'Submit a Mine';

  if(isCorrection && prefill){
    document.getElementById('fSubmissionType').value = 'correction';
    document.getElementById('fName').value = prefill;
    document.getElementById('fExistingMine').value = prefill;
    document.getElementById('correctionNote').style.display = 'block';
    document.getElementById('existingMineRow').style.display = 'block';
    document.getElementById('modalTitle').textContent = 'Suggest a Correction';
    const mine = allData.find(d => d.name === prefill);
    if(mine){
      document.getElementById('fCompany').value = mine.company || '';
      document.getElementById('fCountry').value = mine.country || '';
      document.getElementById('fType').value = mine.type || 'Paste';
      document.getElementById('fTpd').value = mine.tpd || '';
      document.getElementById('fPlants').value = mine.plants || 1;
      document.getElementById('fCommodity').value = mine.commodity || '';
      document.getElementById('fYear').value = mine.year_commissioned || '';
      document.getElementById('fYearDecom').value = mine.year_decommissioned || '';
      document.getElementById('fLat').value = mine.lat || '';
      document.getElementById('fLng').value = mine.lng || '';
      document.getElementById('fNotes').value = mine.notes || '';
      document.getElementById('fSource').value = mine.source || '';
    }
  } else if(prefill){
    document.getElementById('fName').value = prefill;
  }
}

function closeModal(){document.getElementById('submitModal').classList.remove('active')}
function openCorrection(name){openModal(name, true)}

async function submitMine(){
  const name = document.getElementById('fName').value.trim();
  const submitter = document.getElementById('fSubmitter').value.trim();
  if(!name){alert('Mine name is required.');return}
  if(!submitter){alert('Your name is required.');return}

  const payload = {
    mine_name: name,
    company: document.getElementById('fCompany').value.trim() || null,
    country: document.getElementById('fCountry').value.trim() || null,
    fill_type: document.getElementById('fType').value,
    tpd: parseInt(document.getElementById('fTpd').value) || null,
    plants: parseInt(document.getElementById('fPlants').value) || 1,
    commodity: document.getElementById('fCommodity').value.trim() || null,
    commissioned_year: parseInt(document.getElementById('fYear').value) || null,
    decommissioned_year: parseInt(document.getElementById('fYearDecom').value) || null,
    lat: parseFloat(document.getElementById('fLat').value) || null,
    lng: parseFloat(document.getElementById('fLng').value) || null,
    notes: document.getElementById('fNotes').value.trim() || null,
    source_reference: document.getElementById('fSource').value.trim() || null,
    submitter_name: submitter,
    submitter_email: document.getElementById('fEmail').value.trim() || null,
    submission_type: document.getElementById('fSubmissionType').value,
    existing_mine_name: document.getElementById('fExistingMine').value.trim() || null
  };

  try {
    const res = await fetch(SUPABASE_URL + '/rest/v1/mine_submissions', {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) { const err = await res.text(); throw new Error(err); }
    closeModal();
    showToast('Thanks! Your submission will be reviewed.');
  } catch(e) { alert('Error submitting: ' + e.message); }
}

// Welcome popup
(function(){
  if(localStorage.getItem('hideWelcome')==='true'){
    document.getElementById('welcomeOverlay').style.display='none';
  }
})();
function closeWelcome(){
  document.getElementById('welcomeOverlay').style.display='none';
  if(document.getElementById('welcomeDontShow').checked){
    localStorage.setItem('hideWelcome','true');
  }
}
document.getElementById('welcomeGotIt').addEventListener('click',function(e){e.stopPropagation();closeWelcome();});
document.getElementById('welcomeOverlay').addEventListener('click',function(e){if(e.target===this)closeWelcome();});

function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 4000);
}

document.getElementById('submitModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeModal()});

function toggleSidebar(){
  const sb=document.querySelector('.sidebar');
  const btn=document.getElementById('sidebarToggle');
  sb.classList.toggle('open');
  btn.textContent=sb.classList.contains('open')?'‚úï':'üìä';
  setTimeout(()=>{if(map)map.invalidateSize()},350);
}

document.addEventListener('click',e=>{
  const mm=document.querySelector('.mobile-menu');
  const hb=document.querySelector('.hamburger');
  if(mm && mm.classList.contains('open') && !mm.contains(e.target) && e.target!==hb) mm.classList.remove('open');
});

// ============ FEATURE 1: Email Signup ============
function openSubscribeModal(){document.getElementById('subscribeModal').classList.add('active')}
function closeSubscribeModal(){document.getElementById('subscribeModal').classList.remove('active')}
async function submitSubscribe(){
  try{
    const email=document.getElementById('subEmail').value.trim();
    const name=document.getElementById('subName').value.trim()||null;
    if(!email){showToast('Please enter your email.');return}
    const res=await fetch(SUPABASE_URL+'/rest/v1/subscribers',{
      method:'POST',headers:{'apikey':SUPABASE_ANON_KEY,'Authorization':'Bearer '+SUPABASE_ANON_KEY,'Content-Type':'application/json','Prefer':'return=minimal'},
      body:JSON.stringify({email,name})
    });
    if(res.status===409||res.status===400){
      const txt=await res.text();
      if(txt.includes('duplicate')||txt.includes('unique')){showToast("You're already subscribed!");closeSubscribeModal();return}
      throw new Error(txt);
    }
    if(!res.ok)throw new Error(await res.text());
    showToast("Thanks! You're subscribed.");
    closeSubscribeModal();
    document.getElementById('subEmail').value='';
    document.getElementById('subName').value='';
  }catch(e){showToast('Error: '+e.message)}
}

// ============ FEATURE 3: Shareable Mine Links ============
function getShareUrl(mineName){
  return window.location.origin+window.location.pathname+'?mine='+encodeURIComponent(mineName);
}

function copyShareLink(mineName){
  const url=getShareUrl(mineName);
  navigator.clipboard.writeText(url).then(()=>showToast('Link copied!')).catch(()=>{
    const ta=document.createElement('textarea');ta.value=url;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showToast('Link copied!');
  });
}

function checkMineParam(){
  const params=new URLSearchParams(window.location.search);
  const mineName=params.get('mine');
  if(!mineName||!allData.length)return;
  const mine=allData.find(d=>d.name.toLowerCase()===mineName.toLowerCase());
  if(mine&&mine.lat&&mine.lng){
    setTimeout(()=>{
      map.setView([mine.lat,mine.lng],12);
      clusterGroup.eachLayer(layer=>{
        if(layer.getLatLng&&Math.abs(layer.getLatLng().lat-mine.lat)<0.001&&Math.abs(layer.getLatLng().lng-mine.lng)<0.001){
          layer.openPopup();
        }
      });
    },500);
  }
}

// ============ FEATURE 5: Compare Regions ============
let compareSelectedRegions=[], compareChartInstance=null;

function openCompareModal(){
  const regions=[...new Set(allData.map(d=>d.region))].filter(Boolean).sort();
  const sel=document.getElementById('regionSelector');
  sel.innerHTML=regions.map(r=>`<div class="region-chip" onclick="toggleRegionChip(this,'${r}')">${r}</div>`).join('');
  compareSelectedRegions=[];
  document.getElementById('compareCards').innerHTML='<p style="color:var(--muted);font-size:13px;text-align:center;padding:20px">Select regions above to compare</p>';
  if(compareChartInstance){compareChartInstance.destroy();compareChartInstance=null}
  document.getElementById('compareOverlay').classList.add('active');
}

function closeCompareModal(){document.getElementById('compareOverlay').classList.remove('active')}

function toggleRegionChip(el,region){
  if(compareSelectedRegions.includes(region)){
    compareSelectedRegions=compareSelectedRegions.filter(r=>r!==region);
    el.classList.remove('selected');
  }else{
    if(compareSelectedRegions.length>=3){showToast('Max 3 regions');return}
    compareSelectedRegions.push(region);
    el.classList.add('selected');
  }
  renderComparison();
}

function renderComparison(){
  const cards=document.getElementById('compareCards');
  if(!compareSelectedRegions.length){
    cards.innerHTML='<p style="color:var(--muted);font-size:13px;text-align:center;padding:20px">Select regions above to compare</p>';
    if(compareChartInstance){compareChartInstance.destroy();compareChartInstance=null}
    return;
  }
  const stats=compareSelectedRegions.map(region=>{
    const mines=allData.filter(d=>d.region===region);
    const totalTpd=mines.reduce((s,d)=>s+(d.tpd||0),0);
    const avgSize=mines.length?Math.round(totalTpd/mines.filter(d=>d.tpd).length):0;
    // top commodity
    const commCounts={};mines.forEach(d=>{const c=(d.commodity||'unknown').split('/')[0];commCounts[c]=(commCounts[c]||0)+1});
    const topComm=Object.entries(commCounts).sort((a,b)=>b[1]-a[1])[0];
    // top company
    const coCounts={};mines.forEach(d=>{if(d.company)coCounts[d.company]=(coCounts[d.company]||0)+1});
    const topCo=Object.entries(coCounts).sort((a,b)=>b[1]-a[1])[0];
    return{region,count:mines.length,totalTpd,avgSize,topCommodity:topComm?topComm[0]:'‚Äî',topCompany:topCo?topCo[0]:'‚Äî'};
  });

  cards.innerHTML=stats.map(s=>`
    <div class="compare-card">
      <h4>${esc(s.region)}</h4>
      <div class="cc-row"><span class="cc-label">Plants</span><span class="cc-val">${s.count}</span></div>
      <div class="cc-row"><span class="cc-label">Total TPD</span><span class="cc-val">${s.totalTpd.toLocaleString()}</span></div>
      <div class="cc-row"><span class="cc-label">Avg Plant Size</span><span class="cc-val">${s.avgSize.toLocaleString()} tpd</span></div>
      <div class="cc-row"><span class="cc-label">Top Commodity</span><span class="cc-val">${esc(s.topCommodity)}</span></div>
      <div class="cc-row"><span class="cc-label">Top Company</span><span class="cc-val">${esc(s.topCompany)}</span></div>
    </div>
  `).join('');

  // Bar chart
  if(compareChartInstance)compareChartInstance.destroy();
  const ctx=document.getElementById('compareChart').getContext('2d');
  compareChartInstance=new Chart(ctx,{
    type:'bar',
    data:{
      labels:stats.map(s=>s.region),
      datasets:[
        {label:'Plants',data:stats.map(s=>s.count),backgroundColor:'#3498db'},
        {label:'Total TPD (√∑100)',data:stats.map(s=>Math.round(s.totalTpd/100)),backgroundColor:'#00a99d'},
        {label:'Avg Size (tpd)',data:stats.map(s=>s.avgSize),backgroundColor:'#f39c12'}
      ]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{boxWidth:10,font:{size:11}}}},scales:{x:{grid:{display:false}},y:{grid:{color:'#1a3f4a'}}}}
  });
}

// ============ Patch renderMap for share links (Feature 3) ============
const _origRenderMap = renderMap;
renderMap = function(data) {
  if(clusterGroup) map.removeLayer(clusterGroup);
  clusterGroup=L.markerClusterGroup({maxClusterRadius:40,spiderfyOnMaxZoom:true});
  const maxTpd=Math.max(...data.map(d=>d.tpd||0),1);
  data.forEach(d=>{
    if(!d.lat||!d.lng) return;
    const r=Math.max(5,Math.min(25,Math.sqrt((d.tpd||0)/maxTpd)*25));
    const color=REGION_COLORS[d.region]||'#00a99d';
    const marker=L.circleMarker([d.lat,d.lng],{radius:r,fillColor:color,color:'#fff',weight:1,opacity:0.8,fillOpacity:0.65});
    const conf=d.confidence==='verified'?'üü¢':'üü°';
    const yr=d.year_commissioned||'‚Äî';
    const designer=d.designer||'‚Äî';
    const safeName = (d.name||'').replace(/'/g,"\\'").replace(/"/g,'&quot;');
    const statusClass = (d.status||'').toLowerCase()==='operating'?'status-operating':(d.status||'').toLowerCase()==='closed'?'status-closed':'status-other';
    marker.bindPopup(`
      <div class="popup-header">
        <div class="popup-mine-name">${conf} ${esc(d.name)}</div>
        <div class="popup-company">${esc(d.company)||'‚Äî'}</div>
      </div>
      <div class="popup-badges">
        <span class="popup-badge capacity">${(d.tpd||0).toLocaleString()} tpd</span>
        <span class="popup-badge ${fillBadgeClass(d.fill_type)}">${esc(d.fill_type||'Paste')}</span>
        ${d.commodity?'<span class="popup-badge commodity">'+esc(d.commodity)+'</span>':''}
        ${d.status?'<span class="popup-badge '+statusClass+'">'+esc(d.status)+'</span>':''}
      </div>
      <div class="popup-grid">
        <span class="pg-label">Country</span><span class="pg-val">${esc(d.country)}</span>
        <span class="pg-label">Region</span><span class="pg-val">${esc(d.region)}</span>
        <span class="pg-label">Fill Type</span><span class="pg-val">${esc(d.fill_type||'Paste')}</span>
        <span class="pg-label">Plants</span><span class="pg-val">${d.plants||'‚Äî'}</span>
        <span class="pg-label">Ore TPD</span><span class="pg-val">${d.ore_tpd?(d.ore_tpd.toLocaleString()):'‚Äî'}</span>
        <span class="pg-label">Designer</span><span class="pg-val">${esc(designer)}</span>
        <span class="pg-label">Commissioned</span><span class="pg-val">${yr}</span>
        ${d.year_decommissioned?'<span class="pg-label">Decommissioned</span><span class="pg-val" style="color:var(--red)">'+d.year_decommissioned+'</span>':''}
      </div>
      ${d.source?'<div class="popup-source">üìé <a href="'+encodeURI(d.source)+'" target="_blank" rel="noopener">'+esc(d.source_label||'View source')+' ‚Üí</a></div>':''}
      <div class="popup-footer">
        ${d.last_updated?'<div style="margin-bottom:4px;font-size:11px;color:var(--muted)">‚úÖ Last checked '+d.last_updated+(d.updated_by?' by <strong style="color:var(--text)">'+esc(d.updated_by)+'</strong>':'')+'</div>':''}
        <a class="suggest-link" href="#" onclick="copyShareLink('${safeName}');return false">üîó Share</a> ¬∑ 
        <a class="suggest-link" href="#" onclick="openCorrection('${safeName}');return false">üìù Suggest a correction</a>
      </div>
    `,{maxWidth:320,autoPan:true,autoPanPadding:[40,40]});
    clusterGroup.addLayer(marker);
  });
  map.addLayer(clusterGroup);
  if(clusterGroup.getLayers().length) map.fitBounds(clusterGroup.getBounds().pad(0.05));
};

// Hook into initial load to check mine param
const _origApplyFilters = applyFilters;
let _firstLoad = true;
applyFilters = function() {
  _origApplyFilters();
  if (_firstLoad) {
    _firstLoad = false;
    checkMineParam();
  }
};
</script>
</body>
</html>
