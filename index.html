<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Paste Backfill Plant Map | MineSmart</title>
<meta name="description" content="Interactive map of 190+ paste backfill plants worldwide. Explore capacity, commodity, and regional data.">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a1a1f;--panel:#0d2329;--card:#112e36;--accent:#00a99d;--brand:#004a59;--text:#e0e8ea;--muted:#7a9ca8;--border:#1a3f4a;--red:#e74c3c;--yellow:#f1c40f;--green:#2ecc71}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh;display:flex;flex-direction:column}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}

/* Header */
.header{background:linear-gradient(135deg,var(--brand),#002a33);padding:8px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--accent);z-index:1000;flex-shrink:0}
.header-left{display:flex;align-items:center;gap:12px}
.header-left img{height:32px}
.header-left h1{font-size:18px;font-weight:600;letter-spacing:0.5px}
.header-right{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#fff;border:none;padding:7px 14px;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
.btn:hover{background:#00c9b7;transform:translateY(-1px)}
.btn-outline{background:transparent;border:1px solid var(--accent);color:var(--accent)}
.btn-outline:hover{background:var(--accent);color:#fff}

/* Main layout */
.main{display:flex;flex:1;overflow:hidden}
.map-container{flex:1;position:relative;min-width:0}
#map{width:100%;height:100%;background:var(--bg)}

/* Sidebar */
.sidebar{width:380px;background:var(--panel);overflow-y:auto;border-left:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column}
.sidebar::-webkit-scrollbar{width:6px}
.sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Stats cards */
.stats-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px}
.stat-card{background:var(--card);border-radius:6px;padding:12px;text-align:center;border:1px solid var(--border)}
.stat-card .value{font-size:24px;font-weight:700;color:var(--accent)}
.stat-card .label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px}

/* Chart sections */
.chart-section{padding:8px 12px}
.chart-section h3{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:6px;border-bottom:1px solid var(--border);padding-bottom:4px}
.chart-wrap{position:relative;max-height:200px}

/* CTA */
.cta-section{padding:12px;display:flex;flex-direction:column;gap:6px;margin-top:auto}
.cta-section .btn{text-align:center;font-size:14px;padding:10px}

/* Filter bar on map */
.filter-bar{position:absolute;top:10px;left:50px;right:10px;z-index:800;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.filter-bar select,.filter-bar input{background:rgba(13,35,41,0.95);color:var(--text);border:1px solid var(--border);padding:6px 10px;border-radius:4px;font-size:12px;backdrop-filter:blur(8px)}
.filter-bar input{width:180px}
.filter-bar select{min-width:110px}
.filter-bar select:focus,.filter-bar input:focus{outline:none;border-color:var(--accent)}

/* Footer */
.footer{background:var(--brand);padding:6px 20px;font-size:11px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;border-top:1px solid var(--border)}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;justify-content:center;align-items:center}
.modal-overlay.active{display:flex}
.modal{background:var(--panel);border-radius:8px;padding:24px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}
.modal h2{margin-bottom:16px;font-size:18px;color:var(--accent)}
.modal label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px;text-transform:uppercase;letter-spacing:0.5px}
.modal input,.modal select,.modal textarea{width:100%;background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:4px;font-size:13px}
.modal textarea{height:60px;resize:vertical}
.modal input:focus,.modal select:focus,.modal textarea:focus{outline:none;border-color:var(--accent)}
.modal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}
.modal .close-btn{position:absolute;right:12px;top:12px;background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer}

/* Leaflet overrides */
.leaflet-popup-content-wrapper{background:var(--card);color:var(--text);border-radius:6px;border:1px solid var(--border)}
.leaflet-popup-tip{background:var(--card)}
.leaflet-popup-content{margin:10px 14px;font-size:13px;line-height:1.5}
.leaflet-popup-content h4{color:var(--accent);margin-bottom:4px;font-size:15px}
.leaflet-popup-content .popup-row{display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid var(--border)}
.leaflet-popup-content .popup-row:last-child{border:none}
.leaflet-popup-content .popup-label{color:var(--muted);font-size:11px}
.leaflet-popup-content .popup-val{font-weight:500}
.leaflet-popup-content .suggest-link{display:inline-block;margin-top:6px;font-size:11px;color:var(--accent)}
.leaflet-control-zoom a{background:var(--card)!important;color:var(--text)!important;border-color:var(--border)!important}
.marker-cluster{background:rgba(0,169,157,0.3)!important}
.marker-cluster div{background:rgba(0,169,157,0.7)!important;color:#fff!important;font-weight:600}

/* Responsive */
@media(max-width:900px){
  .main{flex-direction:column}
  .map-container{height:50vh}
  .sidebar{width:100%;border-left:none;border-top:1px solid var(--border)}
  .filter-bar{left:10px;right:10px;top:10px}
  .header-left h1{font-size:14px}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <img src="https://minesmart.io/wp-content/uploads/2023/03/MineSmart-Logo-White.png" alt="MineSmart" onerror="this.style.display='none'">
    <h1>Global Paste Backfill Plant Map</h1>
  </div>
  <div class="header-right">
    <button class="btn btn-outline" onclick="openModal()">+ Submit a Mine</button>
    <a href="https://minesmart.io" target="_blank" class="btn">Request a Demo</a>
  </div>
</div>

<div class="main">
  <div class="map-container">
    <div class="filter-bar">
      <input type="text" id="searchBox" placeholder="üîç Search mines...">
      <select id="filterRegion"><option value="">All Regions</option></select>
      <select id="filterCommodity"><option value="">All Commodities</option></select>
      <select id="filterStatus"><option value="">All Statuses</option></select>
      <select id="filterConfidence"><option value="">All Confidence</option></select>
    </div>
    <div id="map"></div>
  </div>

  <div class="sidebar">
    <div class="stats-row">
      <div class="stat-card"><div class="value" id="totalMines">‚Äî</div><div class="label">Paste Plants</div></div>
      <div class="stat-card"><div class="value" id="totalTpd">‚Äî</div><div class="label">Total TPD</div></div>
    </div>

    <div class="chart-section">
      <h3>By Region</h3>
      <div class="chart-wrap"><canvas id="chartRegion"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Top 10 by Capacity (tpd)</h3>
      <div class="chart-wrap" style="max-height:220px"><canvas id="chartTop10"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Primary Commodity</h3>
      <div class="chart-wrap"><canvas id="chartCommodity"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Commissioning Timeline</h3>
      <div class="chart-wrap"><canvas id="chartTimeline"></canvas></div>
    </div>

    <div class="chart-section">
      <h3>Status</h3>
      <div class="chart-wrap"><canvas id="chartStatus"></canvas></div>
    </div>

    <div class="cta-section">
      <a href="https://minesmart.io" target="_blank" class="btn">Learn about Backfill Pro</a>
      <a href="https://minesmart.io" target="_blank" class="btn btn-outline">Request a Demo</a>
    </div>
  </div>
</div>

<div class="footer">
  <span>Powered by <a href="https://minesmart.io" target="_blank">MineSmart Solutions Ltd</a> | <strong>Backfill Pro</strong> ‚Äî Paste Operations Management Platform</span>
  <span>Data: L-P G√©linas, industry reports, public filings</span>
</div>

<!-- Submit Modal -->
<div class="modal-overlay" id="submitModal">
  <div class="modal" style="position:relative">
    <button class="close-btn" onclick="closeModal()">&times;</button>
    <h2>Submit a Mine</h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Know of a paste backfill plant not on the map? Submit it here.</p>
    <label>Mine Name *</label><input id="fName" required>
    <label>Company</label><input id="fCompany">
    <label>Country *</label><input id="fCountry">
    <label>Fill Type</label>
    <select id="fType"><option>Paste</option><option>Cemented Paste</option><option>Thickened Tailings</option><option>Other</option></select>
    <label>Paste Capacity (tpd)</label><input id="fTpd" type="number">
    <label>Year Commissioned</label><input id="fYear" type="number">
    <label>Primary Commodity</label><input id="fCommodity">
    <label>Your Name</label><input id="fSubmitter">
    <label>Your Email</label><input id="fEmail" type="email">
    <label>Source / Reference</label><textarea id="fSource"></textarea>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn" onclick="submitMine()">Submit</button>
    </div>
  </div>
</div>

<script>
const REGION_COLORS = {
  'North America':'#3498db','South America':'#e74c3c','Europe':'#f39c12',
  'Africa':'#9b59b6','Asia':'#1abc9c','Australia':'#e67e22'
};
const STATUS_COLORS = {
  'operating':'#2ecc71','closed':'#e74c3c','care & maintenance':'#f39c12',
  'planned':'#3498db','under construction':'#9b59b6','commissioning 2026':'#1abc9c','':'#7f8c8d'
};

let allData=[], map, clusterGroup, charts={};

// Chart.js defaults
Chart.defaults.color='#7a9ca8';
Chart.defaults.borderColor='#1a3f4a';
Chart.defaults.font.size=11;
Chart.defaults.plugins.legend.labels.boxWidth=10;
Chart.defaults.animation.duration=800;

fetch('data.json').then(r=>r.json()).then(data=>{
  allData=data;
  populateFilters(data);
  initMap();
  renderAll(data);
});

function populateFilters(data){
  const add=(id,vals)=>{const s=document.getElementById(id);vals.forEach(v=>{if(v){const o=document.createElement('option');o.value=v;o.textContent=v;s.appendChild(o)}})};
  add('filterRegion',[...new Set(data.map(d=>d.region))].sort());
  // primary commodity (first in slash-separated)
  add('filterCommodity',[...new Set(data.map(d=>(d.commodity||'').split('/')[0]).filter(Boolean))].sort());
  add('filterStatus',[...new Set(data.map(d=>d.status).filter(Boolean))].sort());
  add('filterConfidence',[...new Set(data.map(d=>d.confidence).filter(Boolean))].sort());
  document.querySelectorAll('.filter-bar select, .filter-bar input').forEach(el=>el.addEventListener('input',applyFilters));
}

function applyFilters(){
  const region=document.getElementById('filterRegion').value;
  const commodity=document.getElementById('filterCommodity').value;
  const status=document.getElementById('filterStatus').value;
  const confidence=document.getElementById('filterConfidence').value;
  const search=document.getElementById('searchBox').value.toLowerCase();
  const filtered=allData.filter(d=>{
    if(region && d.region!==region) return false;
    if(commodity && !(d.commodity||'').toLowerCase().includes(commodity.toLowerCase())) return false;
    if(status && d.status!==status) return false;
    if(confidence && d.confidence!==confidence) return false;
    if(search && !d.name.toLowerCase().includes(search) && !(d.company||'').toLowerCase().includes(search) && !(d.country||'').toLowerCase().includes(search)) return false;
    return true;
  });
  renderAll(filtered);
}

function initMap(){
  map=L.map('map',{zoomControl:true,attributionControl:false}).setView([20,0],2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:18}).addTo(map);
  L.control.attribution({prefix:false,position:'bottomright'}).addAttribution('¬© <a href="https://carto.com">CARTO</a> ¬© <a href="https://osm.org">OSM</a>').addTo(map);
}

function renderAll(data){
  renderMap(data);
  renderStats(data);
  renderCharts(data);
}

function renderMap(data){
  if(clusterGroup) map.removeLayer(clusterGroup);
  clusterGroup=L.markerClusterGroup({maxClusterRadius:40,spiderfyOnMaxZoom:true});
  const maxTpd=Math.max(...data.map(d=>d.tpd||0),1);
  data.forEach(d=>{
    if(!d.lat||!d.lng) return;
    const r=Math.max(5,Math.min(25,Math.sqrt((d.tpd||0)/maxTpd)*25));
    const color=REGION_COLORS[d.region]||'#00a99d';
    const marker=L.circleMarker([d.lat,d.lng],{radius:r,fillColor:color,color:'#fff',weight:1,opacity:0.8,fillOpacity:0.65});
    const conf=d.confidence==='verified'?'üü¢':'üü°';
    const yr=d.year_commissioned||'‚Äî';
    const designer=d.designer||'‚Äî';
    marker.bindPopup(`
      <h4>${d.name}</h4>
      <div class="popup-row"><span class="popup-label">Company</span><span class="popup-val">${d.company||'‚Äî'}</span></div>
      <div class="popup-row"><span class="popup-label">Country</span><span class="popup-val">${d.country}</span></div>
      <div class="popup-row"><span class="popup-label">Region</span><span class="popup-val">${d.region}</span></div>
      <div class="popup-row"><span class="popup-label">Fill Type</span><span class="popup-val">${d.type}</span></div>
      <div class="popup-row"><span class="popup-label">Paste Capacity</span><span class="popup-val">${(d.tpd||0).toLocaleString()} tpd</span></div>
      <div class="popup-row"><span class="popup-label">Ore Throughput</span><span class="popup-val">${d.ore_tpd?(d.ore_tpd.toLocaleString()+' tpd'):'‚Äî'}</span></div>
      <div class="popup-row"><span class="popup-label">Commissioned</span><span class="popup-val">${yr}</span></div>
      <div class="popup-row"><span class="popup-label">Designer</span><span class="popup-val">${designer}</span></div>
      <div class="popup-row"><span class="popup-label">Status</span><span class="popup-val">${d.status||'‚Äî'}</span></div>
      <div class="popup-row"><span class="popup-label">Confidence</span><span class="popup-val">${conf} ${d.confidence||'‚Äî'}</span></div>
      <div class="popup-row"><span class="popup-label">Commodity</span><span class="popup-val">${d.commodity||'‚Äî'}</span></div>
      <a class="suggest-link" href="#" onclick="openCorrection('${d.name.replace(/'/g,"\\'")}');return false">üìù Suggest a correction</a>
    `,{maxWidth:300});
    clusterGroup.addLayer(marker);
  });
  map.addLayer(clusterGroup);
}

function renderStats(data){
  document.getElementById('totalMines').textContent=data.length;
  const total=data.reduce((s,d)=>s+(d.tpd||0),0);
  document.getElementById('totalTpd').textContent=total>=1e6?(total/1e6).toFixed(1)+'M':total>=1e3?(total/1e3).toFixed(0)+'K':total;
}

function renderCharts(data){
  // Region pie
  const regionCounts={};
  data.forEach(d=>{regionCounts[d.region]=(regionCounts[d.region]||0)+1});
  const regionLabels=Object.keys(regionCounts).sort();
  makeChart('chartRegion','doughnut',regionLabels,regionLabels.map(r=>regionCounts[r]),regionLabels.map(r=>REGION_COLORS[r]||'#666'));

  // Top 10
  const top10=[...data].sort((a,b)=>(b.tpd||0)-(a.tpd||0)).slice(0,10);
  makeChart('chartTop10','bar',top10.map(d=>d.name.length>20?d.name.slice(0,18)+'‚Ä¶':d.name),top10.map(d=>d.tpd||0),top10.map(d=>REGION_COLORS[d.region]||'#00a99d'),{indexAxis:'y',plugins:{legend:{display:false}}});

  // Commodity donut ‚Äî primary commodity
  const commCounts={};
  data.forEach(d=>{const c=(d.commodity||'unknown').split('/')[0];commCounts[c]=(commCounts[c]||0)+1});
  const commSorted=Object.entries(commCounts).sort((a,b)=>b[1]-a[1]);
  const topComm=commSorted.slice(0,8);
  const otherCount=commSorted.slice(8).reduce((s,e)=>s+e[1],0);
  if(otherCount>0) topComm.push(['other',otherCount]);
  const commColors=['#3498db','#e74c3c','#f39c12','#2ecc71','#9b59b6','#e67e22','#1abc9c','#34495e','#7f8c8d'];
  makeChart('chartCommodity','doughnut',topComm.map(c=>c[0]),topComm.map(c=>c[1]),commColors);

  // Timeline
  const decades={};
  data.forEach(d=>{
    const y=d.year_commissioned;
    if(y){const dec=Math.floor(y/5)*5;decades[dec]=(decades[dec]||0)+1}
  });
  const decLabels=Object.keys(decades).sort();
  makeChart('chartTimeline','bar',decLabels.map(d=>d+'s'),decLabels.map(d=>decades[d]),'#00a99d',{plugins:{legend:{display:false}}});

  // Status
  const statusCounts={};
  data.forEach(d=>{const s=d.status||'unknown';statusCounts[s]=(statusCounts[s]||0)+1});
  const statusLabels=Object.keys(statusCounts).sort();
  makeChart('chartStatus','doughnut',statusLabels,statusLabels.map(s=>statusCounts[s]),statusLabels.map(s=>STATUS_COLORS[s]||'#7f8c8d'));
}

function makeChart(id,type,labels,values,colors,extraOpts={}){
  if(charts[id]) charts[id].destroy();
  const ctx=document.getElementById(id).getContext('2d');
  const isBar=type==='bar';
  charts[id]=new Chart(ctx,{
    type,
    data:{
      labels,
      datasets:[{data:values,backgroundColor:Array.isArray(colors)?colors:colors,borderWidth:0,borderRadius:isBar?3:0}]
    },
    options:{
      responsive:true,maintainAspectRatio:true,
      plugins:{legend:{display:!isBar,position:'right',labels:{padding:6,font:{size:10}}}},
      scales:isBar?{x:{grid:{display:false}},y:{grid:{color:'#1a3f4a'}}}:undefined,
      ...extraOpts
    }
  });
}

// Modal
function openModal(prefill){
  document.getElementById('submitModal').classList.add('active');
  if(prefill) document.getElementById('fName').value=prefill;
}
function closeModal(){document.getElementById('submitModal').classList.remove('active')}
function openCorrection(name){openModal(name)}

function submitMine(){
  const fields={
    name:document.getElementById('fName').value,
    company:document.getElementById('fCompany').value,
    country:document.getElementById('fCountry').value,
    type:document.getElementById('fType').value,
    tpd:document.getElementById('fTpd').value,
    year:document.getElementById('fYear').value,
    commodity:document.getElementById('fCommodity').value,
    submitter:document.getElementById('fSubmitter').value,
    email:document.getElementById('fEmail').value,
    source:document.getElementById('fSource').value
  };
  if(!fields.name||!fields.country){alert('Mine name and country are required.');return}
  // Store in localStorage
  const pending=JSON.parse(localStorage.getItem('pendingSubmissions')||'[]');
  pending.push({...fields,submitted:new Date().toISOString()});
  localStorage.setItem('pendingSubmissions',JSON.stringify(pending));
  // Also open mailto
  const body=Object.entries(fields).map(([k,v])=>`${k}: ${v}`).join('\n');
  window.open(`mailto:info@minesmart.io?subject=Paste Plant Submission: ${encodeURIComponent(fields.name)}&body=${encodeURIComponent(body)}`);
  closeModal();
  document.querySelectorAll('.modal input,.modal textarea').forEach(el=>el.value='');
  alert(`Thank you! ${pending.length} submission(s) recorded.`);
}

// Close modal on overlay click
document.getElementById('submitModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeModal()});
</script>
</body>
</html>
