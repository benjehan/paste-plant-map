<!DOCTYPE html>
<html lang="en">
<head>
<!--
  SETUP INSTRUCTIONS:
  1. Run schema-auth.sql in Supabase SQL Editor
  2. Go to Supabase Dashboard > Authentication > Users > Add User
     Email: ben@minesmart.io, set a password
  3. Run in SQL Editor:
     INSERT INTO admin_users (id, email) SELECT id, email FROM auth.users WHERE email = 'ben@minesmart.io';
  4. Login at this page with your email and password
-->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin ‚Äî Paste Plant Map | MineSmart</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a1a1f;--panel:#0d2329;--card:#112e36;--accent:#00a99d;--brand:#004a59;--text:#e0e8ea;--muted:#7a9ca8;--border:#1a3f4a;--red:#e74c3c;--yellow:#f1c40f;--green:#2ecc71}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--accent);text-decoration:none}
.header{background:linear-gradient(135deg,var(--brand),#002a33);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--accent)}
.header h1{font-size:18px;font-weight:600}
.header-right{display:flex;gap:10px;align-items:center}
.btn{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
.btn:hover{background:#00c9b7}
.btn-red{background:var(--red)}.btn-red:hover{background:#c0392b}
.btn-outline{background:transparent;border:1px solid var(--accent);color:var(--accent)}
.btn-outline:hover{background:var(--accent);color:#fff}
.btn-sm{padding:5px 10px;font-size:12px}

.container{max-width:1200px;margin:0 auto;padding:20px}
.stats-bar{display:flex;gap:16px;margin-bottom:20px}
.stat-box{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:16px 24px;text-align:center}
.stat-box .num{font-size:28px;font-weight:700;color:var(--accent)}
.stat-box .lbl{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
.stat-box.pending .num{color:var(--yellow)}

.card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:16px;margin-bottom:12px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.card-header h3{font-size:16px;color:var(--accent)}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;text-transform:uppercase}
.badge-pending{background:var(--yellow);color:#000}
.badge-approved{background:var(--green);color:#000}
.badge-rejected{background:var(--red);color:#fff}
.type-badge{background:var(--brand);color:var(--accent);padding:2px 8px;border-radius:10px;font-size:11px;margin-left:8px}

.fields{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px 16px;font-size:13px}
.fields .f{display:flex;gap:6px}
.fields .f .fl{color:var(--muted);min-width:100px;font-size:11px;text-transform:uppercase}
.card-actions{display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:2000;justify-content:center;align-items:center}
.modal-overlay.active{display:flex}
.modal{background:var(--panel);border-radius:8px;padding:24px;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}
.modal h2{margin-bottom:16px;color:var(--accent);font-size:18px}
.modal label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px;text-transform:uppercase}
.modal input,.modal select,.modal textarea{width:100%;background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px;border-radius:4px;font-size:13px}
.modal textarea{height:80px;resize:vertical}
.modal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}

.empty{text-align:center;padding:60px 20px;color:var(--muted);font-size:16px}
.toast{position:fixed;bottom:20px;right:20px;background:var(--green);color:#fff;padding:12px 20px;border-radius:6px;font-size:14px;z-index:3000;display:none}
#loginScreen{display:flex;justify-content:center;align-items:center;min-height:80vh}
#loginScreen .login-box{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:32px;text-align:center;width:360px}
#loginScreen h2{color:var(--accent);margin-bottom:16px}
#loginScreen input{width:100%;background:var(--panel);color:var(--text);border:1px solid var(--border);padding:10px;border-radius:4px;font-size:13px;margin-bottom:12px}
.login-error{color:var(--red);font-size:13px;margin-bottom:12px;display:none}
.user-email{color:var(--muted);font-size:12px;margin-right:8px}
</style>
</head>
<body>

<div class="header">
  <h1>üîí Paste Plant Map ‚Äî Admin</h1>
  <div class="header-right">
    <a href="index.html" class="btn btn-outline btn-sm">‚Üê Back to Map</a>
    <span class="user-email" id="userEmail"></span>
    <button class="btn btn-sm btn-red" onclick="logout()" id="logoutBtn" style="display:none">Logout</button>
  </div>
</div>

<div class="container">
  <div id="loginScreen">
    <div class="login-box">
      <h2>Admin Login</h2>
      <p style="color:var(--muted);font-size:13px;margin-bottom:16px">Sign in with your admin email and password</p>
      <div class="login-error" id="loginError"></div>
      <input type="email" id="emailInput" placeholder="Email address">
      <input type="password" id="passwordInput" placeholder="Password">
      <button class="btn" onclick="login()" style="width:100%" id="loginBtn">Login</button>
    </div>
  </div>

  <div id="adminPanel" style="display:none">
    <div class="stats-bar">
      <div class="stat-box pending"><div class="num" id="pendingCount">0</div><div class="lbl">Pending</div></div>
      <div class="stat-box"><div class="num" id="approvedCount">0</div><div class="lbl">Approved</div></div>
      <div class="stat-box"><div class="num" id="rejectedCount">0</div><div class="lbl">Rejected</div></div>
      <div class="stat-box"><div class="num" id="totalCount">0</div><div class="lbl">Total</div></div>
    </div>
    <div id="submissionsList"></div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h2 id="editTitle">Edit Submission</h2>
    <input type="hidden" id="editId">
    <label>Mine Name</label><input id="eName">
    <label>Company</label><input id="eCompany">
    <label>Country</label><input id="eCountry">
    <label>Region</label><input id="eRegion">
    <label>Fill Type</label><input id="eFillType">
    <label>TPD</label><input id="eTpd" type="number">
    <label>Plants</label><input id="ePlants" type="number">
    <label>Commodity</label><input id="eCommodity">
    <label>Year Commissioned</label><input id="eYear" type="number">
    <label>Designer</label><input id="eDesigner">
    <label>Lat</label><input id="eLat" type="number" step="any">
    <label>Lng</label><input id="eLng" type="number" step="any">
    <label>Notes</label><textarea id="eNotes"></textarea>
    <label>Admin Notes</label><textarea id="eAdminNotes"></textarea>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeEdit()">Cancel</button>
      <button class="btn" onclick="saveEdit()">Save</button>
      <button class="btn" style="background:var(--green)" onclick="saveAndApprove()">Save & Approve</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://cxsariervcthxoudumaq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4c2FyaWVydmN0aHhvdWR1bWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTcwMTAsImV4cCI6MjA4Nzc3MzAxMH0.KmjcyBRtRRgvg4FZarJ935wjcKZ4PTThszKWbFPzwUY';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Check for existing session on load
(async function init() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    showAdmin(session.user.email);
  }

  // Listen for auth changes
  supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_OUT') {
      location.reload();
    }
  });
})();

async function login() {
  const email = document.getElementById('emailInput').value.trim();
  const password = document.getElementById('passwordInput').value;
  const errEl = document.getElementById('loginError');
  const btn = document.getElementById('loginBtn');
  
  if (!email || !password) { errEl.textContent = 'Enter email and password'; errEl.style.display = 'block'; return; }
  
  btn.disabled = true; btn.textContent = 'Signing in...';
  errEl.style.display = 'none';

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  
  if (error) {
    errEl.textContent = error.message;
    errEl.style.display = 'block';
    btn.disabled = false; btn.textContent = 'Login';
    return;
  }

  showAdmin(data.user.email);
}

function showAdmin(email) {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('adminPanel').style.display = 'block';
  document.getElementById('logoutBtn').style.display = 'block';
  document.getElementById('userEmail').textContent = email;
  loadSubmissions();
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

// Enter key to login
document.getElementById('passwordInput')?.addEventListener('keydown', e => { if (e.key === 'Enter') login(); });

async function loadSubmissions() {
  try {
    const { data, error } = await supabase
      .from('mine_submissions')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) throw error;
    renderSubmissions(data);
  } catch (e) {
    document.getElementById('submissionsList').innerHTML = `<div class="empty">Error loading: ${e.message}</div>`;
  }
}

function renderSubmissions(data) {
  const pending = data.filter(d => d.status === 'pending').length;
  const approved = data.filter(d => d.status === 'approved').length;
  const rejected = data.filter(d => d.status === 'rejected').length;
  document.getElementById('pendingCount').textContent = pending;
  document.getElementById('approvedCount').textContent = approved;
  document.getElementById('rejectedCount').textContent = rejected;
  document.getElementById('totalCount').textContent = data.length;

  if (!data.length) {
    document.getElementById('submissionsList').innerHTML = '<div class="empty">No submissions yet.</div>';
    return;
  }

  document.getElementById('submissionsList').innerHTML = data.map(d => {
    const bc = d.status === 'pending' ? 'pending' : d.status === 'approved' ? 'approved' : 'rejected';
    const date = new Date(d.created_at).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });
    return `<div class="card">
      <div class="card-header">
        <h3>${esc(d.mine_name)} <span class="type-badge">${d.submission_type}</span></h3>
        <span class="badge badge-${bc}">${d.status}</span>
      </div>
      <div class="fields">
        <div class="f"><span class="fl">Company</span>${esc(d.company||'‚Äî')}</div>
        <div class="f"><span class="fl">Country</span>${esc(d.country||'‚Äî')}</div>
        <div class="f"><span class="fl">Region</span>${esc(d.region||'‚Äî')}</div>
        <div class="f"><span class="fl">Fill Type</span>${esc(d.fill_type||'‚Äî')}</div>
        <div class="f"><span class="fl">TPD</span>${d.tpd||'‚Äî'}</div>
        <div class="f"><span class="fl">Plants</span>${d.plants||'‚Äî'}</div>
        <div class="f"><span class="fl">Commodity</span>${esc(d.commodity||'‚Äî')}</div>
        <div class="f"><span class="fl">Year</span>${d.commissioned_year||'‚Äî'}</div>
        <div class="f"><span class="fl">Designer</span>${esc(d.designer||'‚Äî')}</div>
        <div class="f"><span class="fl">Lat/Lng</span>${d.lat||'‚Äî'}, ${d.lng||'‚Äî'}</div>
        <div class="f"><span class="fl">Submitter</span>${esc(d.submitter_name)} ${d.submitter_email?'('+esc(d.submitter_email)+')':''}</div>
        <div class="f"><span class="fl">Submitted</span>${date}</div>
        ${d.existing_mine_name?`<div class="f"><span class="fl">Existing Mine</span>${esc(d.existing_mine_name)}</div>`:''}
        ${d.notes?`<div class="f"><span class="fl">Notes</span>${esc(d.notes)}</div>`:''}
        ${d.source_reference?`<div class="f"><span class="fl">Source</span>${esc(d.source_reference)}</div>`:''}
        ${d.admin_notes?`<div class="f"><span class="fl">Admin Notes</span>${esc(d.admin_notes)}</div>`:''}
      </div>
      <div class="card-actions">
        ${d.status==='pending'?`
          <button class="btn btn-sm" style="background:var(--green)" onclick="approve('${d.id}')">‚úì Approve</button>
          <button class="btn btn-sm btn-red" onclick="reject('${d.id}')">‚úó Reject</button>
        `:''}
        <button class="btn btn-sm btn-outline" onclick="openEdit('${d.id}')">Edit</button>
      </div>
    </div>`;
  }).join('');
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

async function approve(id) {
  try {
    const { error } = await supabase
      .from('mine_submissions')
      .update({ status: 'approved', reviewed_at: new Date().toISOString() })
      .eq('id', id);
    if (error) throw error;
    showToast('Approved!');
    loadSubmissions();
  } catch(e) { alert('Error: ' + e.message); }
}

async function reject(id) {
  const notes = prompt('Rejection reason (optional):');
  try {
    const body = { status: 'rejected', reviewed_at: new Date().toISOString() };
    if (notes) body.admin_notes = notes;
    const { error } = await supabase
      .from('mine_submissions')
      .update(body)
      .eq('id', id);
    if (error) throw error;
    showToast('Rejected');
    loadSubmissions();
  } catch(e) { alert('Error: ' + e.message); }
}

async function openEdit(id) {
  try {
    const { data, error } = await supabase
      .from('mine_submissions')
      .select('*')
      .eq('id', id);
    if (error) throw error;
    if (!data.length) return;
    const d = data[0];
    document.getElementById('editId').value = d.id;
    document.getElementById('eName').value = d.mine_name || '';
    document.getElementById('eCompany').value = d.company || '';
    document.getElementById('eCountry').value = d.country || '';
    document.getElementById('eRegion').value = d.region || '';
    document.getElementById('eFillType').value = d.fill_type || '';
    document.getElementById('eTpd').value = d.tpd || '';
    document.getElementById('ePlants').value = d.plants || '';
    document.getElementById('eCommodity').value = d.commodity || '';
    document.getElementById('eYear').value = d.commissioned_year || '';
    document.getElementById('eDesigner').value = d.designer || '';
    document.getElementById('eLat').value = d.lat || '';
    document.getElementById('eLng').value = d.lng || '';
    document.getElementById('eNotes').value = d.notes || '';
    document.getElementById('eAdminNotes').value = d.admin_notes || '';
    document.getElementById('editModal').classList.add('active');
  } catch(e) { alert('Error: ' + e.message); }
}

function closeEdit() { document.getElementById('editModal').classList.remove('active'); }

function getEditBody() {
  return {
    mine_name: document.getElementById('eName').value,
    company: document.getElementById('eCompany').value || null,
    country: document.getElementById('eCountry').value || null,
    region: document.getElementById('eRegion').value || null,
    fill_type: document.getElementById('eFillType').value || null,
    tpd: parseInt(document.getElementById('eTpd').value) || null,
    plants: parseInt(document.getElementById('ePlants').value) || null,
    commodity: document.getElementById('eCommodity').value || null,
    commissioned_year: parseInt(document.getElementById('eYear').value) || null,
    designer: document.getElementById('eDesigner').value || null,
    lat: parseFloat(document.getElementById('eLat').value) || null,
    lng: parseFloat(document.getElementById('eLng').value) || null,
    notes: document.getElementById('eNotes').value || null,
    admin_notes: document.getElementById('eAdminNotes').value || null
  };
}

async function saveEdit() {
  const id = document.getElementById('editId').value;
  try {
    const { error } = await supabase
      .from('mine_submissions')
      .update(getEditBody())
      .eq('id', id);
    if (error) throw error;
    closeEdit(); showToast('Saved!'); loadSubmissions();
  } catch(e) { alert('Error: ' + e.message); }
}

async function saveAndApprove() {
  const id = document.getElementById('editId').value;
  const body = { ...getEditBody(), status: 'approved', reviewed_at: new Date().toISOString() };
  try {
    const { error } = await supabase
      .from('mine_submissions')
      .update(body)
      .eq('id', id);
    if (error) throw error;
    closeEdit(); showToast('Saved & Approved!'); loadSubmissions();
  } catch(e) { alert('Error: ' + e.message); }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 3000);
}

document.getElementById('editModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeEdit(); });
</script>
</body>
</html>
